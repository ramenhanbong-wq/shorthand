<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHORTHAND PRO - ë˜‘ì†Œë¦¬ 2 (í†µí•©íŒ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --bg-body: #F0F4F8;
            --sidebar-bg: #F8F9FA;
            --primary: #6C5CE7; 
            --primary-light: #A29BFE;
            --text-dark: #2D3436; 
            --text-grey: #636E72;
            --white: #FFFFFF;
            --shadow-card: 0 4px 20px rgba(0,0,0,0.03);
            --radius-card: 24px;
            --fail: #FF7675; 
            --success: #00B894; 
            --gold: #FD79A8;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background: var(--bg-body);
            color: var(--text-dark); margin: 0; padding: 0; 
            display: flex; height: 100vh; overflow: hidden;
        }

        /* [UI] ìŠ¤ìœ„ì¹˜ í† ê¸€ ìŠ¤íƒ€ì¼ (ì‹ ê·œ ì¶”ê°€) */
        .toggle-switch {
            position: relative; display: inline-block; width: 50px; height: 26px; vertical-align: middle; margin-right: 10px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* ëª¨ë°”ì¼ ì „ìš© ë²„íŠ¼ */
        .mobile-menu-btn {
            display: none; position: fixed; top: 15px; left: 15px; z-index: 1001;
            background: var(--primary); color: white; border: none;
            border-radius: 8px; padding: 8px 12px; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .sidebar-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(3px);
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 260px; background: var(--sidebar-bg); padding: 30px 20px; 
            display: flex; flex-direction: column; border-right: 2px solid #E1E4E8;
            flex-shrink: 0; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.03);
            transition: transform 0.3s ease;
        }
        .logo { font-size: 1.4rem; font-weight: 900; color: var(--primary); margin-bottom: 40px; padding-left: 10px; }
        .nav-list { list-style: none; padding: 0; margin: 0; flex: 1; }
        .nav-item {
            padding: 14px 18px; margin-bottom: 12px; border-radius: 14px;
            color: var(--text-grey); font-weight: 700; cursor: pointer; text-decoration: none;
            display: flex; align-items: center; gap: 12px; transition: 0.2s;
            background: white; border: 1px solid #EAEAEA; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .nav-item:hover, .nav-item.active { 
            background: var(--primary); color: white; border-color: var(--primary);
            transform: translateY(-2px); box-shadow: 0 4px 8px rgba(108, 92, 231, 0.3);
        }
        .nav-icon { width: 24px; text-align: center; }

        .profile-card {
            background: white; padding: 15px; border-radius: 16px;
            display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.3s; margin-top: auto;
            border: 1px solid #EAEAEA;
        }
        .profile-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            flex: 1; padding: 40px 50px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
        }
        
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .page-title h2 { font-size: 1.8rem; font-weight: 800; margin: 0; color: var(--text-dark); }
        .page-title p { color: var(--text-grey); margin: 5px 0 0 0; }

        .card-box {
            background: var(--white); border-radius: var(--radius-card); padding: 30px;
            box-shadow: var(--shadow-card); transition: 0.3s; border: 1px solid #DCE0E5;
        }

        .ranking-banner {
            background: linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%);
            color: white; padding: 20px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 20px rgba(108, 92, 231, 0.2); margin-bottom: 20px;
            border: 2px solid white; outline: 2px solid #a29bfe;
        }
        .ranking-list { display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .ranking-item { padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); }

        .config-row { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .config-item { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .styled-input {
            padding: 12px 15px; border: 2px solid #E1E4E8; border-radius: 12px;
            font-size: 1rem; outline: none; transition: 0.2s; background: #F8F9FA;
        }
        .styled-input:focus { border-color: var(--primary); background: #fff; }

        .audio-player-card { 
            background: #F8F9FA; border-radius: 20px; padding: 20px; border: 1px solid #E1E4E8;
        }
        .play-btn-circle {
            width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: white;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3); transition: 0.2s;
        }
        .play-btn-circle:hover { transform: scale(1.1); }
        .play-btn-circle:disabled { background: #ddd; box-shadow: none; cursor: not-allowed; }
        
        .progress-container input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--primary); }
        .time-wrapper { font-size: 0.85rem; color: #888; font-weight: 600; text-align: right; margin-top: 5px; }

        /* [ìˆ˜ì •ë¨] ì…ë ¥ ë ˆì´ì•„ì›ƒ ë™ì  ë³€í™” */
        .input-layout-col { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        
        /* ê¸°ë³¸ ìƒíƒœ: ìœ„ì•„ë˜ ë°°ì¹˜ */
        .input-wrapper { display: flex; flex-direction: column; gap: 10px; }
        
        /* í™•ì¥ ìƒíƒœìš© (ìˆ¨ê¹€ ì²˜ë¦¬ ë“±) */
        #postEditSection { display: none; transition: all 0.3s ease; }
        #postEditSection.active { display: block; animation: fadeIn 0.5s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .styled-textarea {
            width: 100%; height: 250px; padding: 20px; 
            border: 2px solid #E1E4E8; border-radius: 16px;
            resize: none; font-size: 1.1rem; line-height: 1.8; box-sizing: border-box; outline: none;
            transition: 0.2s; font-family: 'Pretendard', sans-serif; background: #FFFEFC;
        }
        .styled-textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1); background: white; }
        
        .label-badge { display: inline-block; background: #EEEBFF; color: var(--primary); padding: 5px 12px; border-radius: 8px; font-weight: 800; font-size: 0.9rem; border: 1px solid #D1C4E9; }

        .btn-primary {
            background: var(--primary); color: white; border: none; padding: 15px 30px;
            border-radius: 16px; font-size: 1.1rem; font-weight: 800; cursor: pointer;
            width: 100%; margin-top: 20px; transition: 0.2s; box-shadow: 0 10px 20px rgba(108, 92, 231, 0.2);
            border: 2px solid transparent;
        }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(108, 92, 231, 0.3); border-color: #A29BFE; }

        .btn-ghost { background: #fff; border: 2px solid #E1E4E8; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666; transition: 0.2s; }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }

        /* ê²°ê³¼ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .diff-view { 
            background: #fff; padding: 30px; border: 2px solid #E1E4E8; border-radius: 16px; 
            font-size: 20px; line-height: 2.5; white-space: pre-wrap; word-break: break-all; margin-top: 20px;
        }
        .d-missing { background: #FFEBEE; color: #FF7675; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        .d-added { color: #00B894; font-weight: bold; text-decoration: underline; }
        .d-wrong { border-bottom: 2px solid var(--primary); position: relative; font-weight: bold; color: var(--primary); }
        .correction { 
            position: absolute; top: -1.4em; left: 0; font-size: 0.8em; line-height: 1;
            color: white; background: var(--primary); padding: 3px 6px; border-radius: 5px; white-space: nowrap;
        }

        /* ì •ë°€ ë¶„ì„ í•˜ì´ë¼ì´íŠ¸ */
        .review-view { background: #fff; line-height: 2.5; font-size: 1.1rem; color: #333; }
        .hl-success { background: #b2fab4; border-bottom: 2px solid #00B894; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        .hl-warning { background: #fff59d; border-bottom: 2px solid #fbc02d; padding: 2px 4px; border-radius: 4px; }
        .hl-bad { background: #ffccbc; border-bottom: 2px solid #ff5722; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        .hl-missed { color: #d32f2f; text-decoration: underline; text-decoration-style: wavy; }
        .hl-omitted { background: #F5F5F5; color: #B0BEC5; border: 1px dashed #B0BEC5; border-radius: 4px; padding: 0 2px; margin: 0 1px; font-size: 0.95em; }

        .growth-box { background: #E3F2FD; color: #1565C0; padding: 20px; border-radius: 16px; margin-bottom: 20px; display: none; border: 2px solid #90CAF9; }
        .growth-title { font-weight: 800; font-size: 1.1rem; margin-bottom: 8px; display: block; }

        .toast-msg { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            background: var(--text-dark); color: white; padding: 12px 25px; border-radius: 30px; 
            font-weight: bold; z-index: 2000; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; backdrop-filter: blur(5px); }
        #report-modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 400px; background: white; padding: 30px; border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 2001; border: 1px solid #E1E4E8;
        }

        .error-note-area { background: #FFF8E1; border: 2px solid #FFE082; padding: 20px; border-radius: 16px; display: none; margin-bottom: 20px; }
        .error-item-row { background: white; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 0.95rem; border: 1px solid rgba(0,0,0,0.1); }

        @media (max-width: 768px) {
            body { overflow: auto; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 2px 0 15px rgba(0,0,0,0.1); }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .mobile-menu-btn { display: block; }
            .main-content { padding: 70px 20px 20px; width: 100%; box-sizing: border-box; }
            .card-box { padding: 20px; }
        }
    </style>
</head>
<body onload="initApp()">

<button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="streakMsg" class="toast-msg"></div> 
<div id="recordMsg" class="toast-msg" style="background:var(--success);"></div>

<div class="modal-overlay" id="overlay" onclick="closeReport()"></div>
<div id="report-modal">
    <h2 style="text-align:center; color:var(--text-dark); margin-top:0;">ğŸ“… ì´ë‹¬ì˜ í•™ìŠµ ë¦¬í¬íŠ¸</h2>
    <div id="report-content" style="line-height: 2; font-size: 1rem; color:#555;"></div>
    <button onclick="closeReport()" class="btn-primary" style="margin-top:20px; padding:12px;">ë‹«ê¸°</button>
</div>

<nav class="sidebar">
    <div class="logo">âš¡ SHORTHAND</div>
    <ul class="nav-list">
        <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ</a>
        <a href="editorial.html" class="nav-item"><span class="nav-icon">ğŸ“°</span> ì‚¬ì„¤ì—°ìŠµ</a>
        <a href="toksori2.html" class="nav-item active"><span class="nav-icon">ğŸ“</span> ë˜‘ì†Œë¦¬ 2</a>
        <a href="king.html" class="nav-item"><span class="nav-icon">ğŸ‘‘</span> íƒ€ìì™•</a>
        <a href="exam.html" class="nav-item"><span class="nav-icon">ğŸ“</span> ì¡¸ì—…ì‹œí—˜</a>
        <a href="sparta.html" class="nav-item"><span class="nav-icon">ğŸ”¥</span> ìŠ¤íŒŒë¥´íƒ€</a>
        <a href="random.html" class="nav-item"><span class="nav-icon">ğŸ²</span> ì•½ì–´ëœë¤</a>
        <a href="measure.html" class="nav-item"><span class="nav-icon">â±ï¸</span> ììˆ˜ì¸¡ì •</a>
    </ul>
    <div class="profile-card" onclick="logout()">
        <div style="width:35px; height:35px; background:#D6A2E8; border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">U</div>
        <div>
            <div style="font-weight:700; font-size:0.9rem;" id="sideUserName">User</div>
            <div style="font-size:0.75rem; color:#888;">ë¡œê·¸ì•„ì›ƒ</div>
        </div>
    </div>
</nav>

<main class="main-content" id="capture-area">
    <div class="page-header">
        <div class="page-title">
            <h2>ğŸ“ ë˜‘ì†Œë¦¬ 2 (í†µí•©íŒ)</h2>
            <p id="welcomeMsg">ì˜¤ëŠ˜ë„ í™”ì´íŒ…í•˜ì„¸ìš”!</p>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="generateReport()" class="btn-ghost">ğŸ“Š ì›”ê°„ ë¦¬í¬íŠ¸</button>
            <button onclick="logout()" class="btn-ghost" style="color:var(--fail); border-color:var(--fail);">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="ranking-banner">
        <div style="font-size:1.1rem; font-weight:800;">ğŸ‘‘ ì‹¤ì‹œê°„ ì—°ìŠµì™• TOP 3</div>
        <div class="ranking-list" id="kingList">ë¶„ì„ ì¤‘...</div>
    </div>

    <div class="card-box">
        <div class="config-row">
            <div class="config-item" style="flex:2;">
                <label style="font-weight:700; font-size:0.9rem;">ğŸ“‚ íŒŒì¼ëª… (ê¸°ë¡ìš©)</label>
                <input type="text" id="fileName" class="styled-input" placeholder="ì˜ˆ: ì—°ì„¤ë¬¸_01 (ìë™ ì €ì¥ë¨)">
            </div>
            <div class="config-item" style="flex:1;">
                <label style="font-weight:700; font-size:0.9rem;">ğŸ¯ ëª©í‘œ ì ìˆ˜ (%)</label>
                <input type="number" id="targetScore" class="styled-input" value="90">
            </div>
        </div>

        <div class="audio-player-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span style="font-weight:700; color:#555;">ğŸ§ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´</span>
                <label class="btn-ghost" style="font-size:0.8rem; padding:5px 10px; background:white;">
                    ğŸ“‚ ìŒì„± íŒŒì¼ ì—´ê¸° <input type="file" accept="audio/*" style="display:none;" onchange="loadAudioFile(this)">
                </label>
            </div>
            
            <audio id="audioPlayer" style="display:none;"></audio>
            
            <div style="display:flex; align-items:center; gap:20px;">
                <button id="playBtn" class="play-btn-circle" onclick="toggleAudio()" disabled>â–¶</button>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <select id="speedRate" onchange="changeSpeed()" style="border:none; background:transparent; font-weight:bold; cursor:pointer;">
                            <option value="0.8">0.8x (ëŠë¦¼)</option>
                            <option value="1.0" selected>1.0x (ë³´í†µ)</option>
                            <option value="1.2">1.2x (ë¹ ë¦„)</option>
                        </select>
                        <div id="timeDisplay" class="time-wrapper" style="margin:0;">00:00 / 00:00</div>
                    </div>
                    <div class="progress-container">
                        <input type="range" id="audioProgress" value="0" step="0.1" oninput="seekAudio()">
                    </div>
                </div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
            <div style="display:flex; align-items:center;">
                <label class="toggle-switch">
                    <input type="checkbox" id="modeToggle" onchange="toggleMode()">
                    <span class="slider"></span>
                </label>
                <span style="font-weight:700; color:var(--primary); font-size:0.95rem;">
                    ğŸ› ï¸ ë²ˆë¬¸(ìˆ˜ì •) ì—°ìŠµ ëª¨ë“œ ì¼œê¸°
                </span>
            </div>
            
            <button onclick="clearAllInputs()" class="btn-ghost" style="font-size:0.8rem; color:#888;">ğŸ—‘ï¸ ë‚´ìš© ë¹„ìš°ê¸°</button>
        </div>

        <div class="input-layout-col">
            <div class="input-wrapper">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="label-badge">ğŸ“„ ì •ë‹µ(ì›ë³¸)</span>
                    <label style="cursor:pointer; font-size:0.85rem; font-weight:bold; color:var(--primary);">
                        ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° <input type="file" accept=".txt" style="display:none;" onchange="loadFile(this, 'original')">
                    </label>
                </div>
                <textarea id="original" class="styled-textarea" placeholder="ì—¬ê¸°ì— ì •ë‹µ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”."></textarea>
            </div>

            <div class="input-wrapper">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="label-badge" id="lblPre" style="background:#FFF3E0; color:#FF9800; border-color:#FFE0B2;">âœï¸ ë‚´ ì…ë ¥ (ì´ˆì•ˆ)</span>
                    <label style="cursor:pointer; font-size:0.85rem; font-weight:bold; color:var(--primary);">
                        ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° <input type="file" accept=".txt" style="display:none;" onchange="loadFile(this, 'studentPre')">
                    </label>
                </div>
                <textarea id="studentPre" class="styled-textarea" placeholder="ì˜¤ë””ì˜¤ë¥¼ ë“£ê³  ì—¬ê¸°ì— íƒ€ì´í•‘í•˜ì„¸ìš”."></textarea>
            </div>

            <div class="input-wrapper" id="postEditSection">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <span class="label-badge" style="background:#E3F2FD; color:#2196F3; border-color:#BBDEFB;">ğŸ“ ë²ˆë¬¸ í›„ (ìµœì¢… ìˆ˜ì •ë³¸)</span>
                    <label style="cursor:pointer; font-size:0.85rem; font-weight:bold; color:var(--primary);">
                        ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° <input type="file" accept=".txt" style="display:none;" onchange="loadFile(this, 'studentPost')">
                    </label>
                </div>
                <div style="font-size:0.85rem; color:#666; margin:5px 0;">
                    ğŸ’¡ ìœ„ì—ì„œ ì‘ì„±í•œ ì´ˆì•ˆì„ ë³´ê³ , ìˆ˜ì • ì‹œê°„ì„ ê±°ì¹œ ìµœì¢… ë‚´ìš©ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”. (ìë™ìœ¼ë¡œ ì´ˆì•ˆê³¼ ë¹„êµ ë¶„ì„í•©ë‹ˆë‹¤)
                </div>
                <textarea id="studentPost" class="styled-textarea" placeholder="ìˆ˜ì • ì™„ë£Œëœ ìµœì¢… ë‹µì•ˆì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            </div>
        </div>

        <button onclick="analyzeAndGrade()" class="btn-primary">ğŸ’¯ ì±„ì í•˜ê¸°</button>
    </div>

    <div id="result" style="display:none;">
        <div class="card-box" id="result-card-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">ğŸ“Š ë¶„ì„ ê²°ê³¼ (ì´ˆì•ˆ ê¸°ì¤€)</h3>
                <button onclick="saveScreenshot()" class="btn-ghost">ğŸ“¸ ê²°ê³¼ ì €ì¥</button>
            </div>

            <div id="growthBox" class="growth-box"></div>

            <div id="errorNoteArea" class="error-note-area">
                <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleErrorList()">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-weight:bold; color:#F57C00;">ğŸ“ ì˜¤ë‹µ ë…¸íŠ¸</span>
                        <span id="errorToggleIcon" style="font-size:0.8rem; color:#F57C00;">â–¼ (í´ë¦­í•´ì„œ í¼ì¹˜ê¸°)</span>
                    </div>
                    <button onclick="saveErrorNote(); event.stopPropagation();" class="btn-ghost" style="background:white; font-size:0.8rem; padding:5px 10px;">ğŸ’¾ í…ìŠ¤íŠ¸ ì €ì¥</button>
                </div>
                <div id="errorList" style="display:none; margin-top:15px; border-top:1px solid rgba(0,0,0,0.05); padding-top:15px;"></div>
            </div>

            <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px;">
                <div style="flex:1; background:#F8F9FA; border-radius:16px; padding:30px; text-align:center; display:flex; flex-direction:column; justify-content:center; border:1px solid #eee;">
                    <div style="color:#888; margin-bottom:5px;">ì •í™•ë„ (ì´ˆì•ˆ)</div>
                    <div id="finalScore" style="font-size:4rem; font-weight:900; color:var(--primary);">0</div>
                    <div id="scoreDesc" style="font-weight:600; color:#555;"></div>
                </div>
                <div style="flex:1; height:300px; min-width:300px;">
                    <canvas id="scoreChart"></canvas>
                </div>
            </div>

            <div class="diff-view" id="diffOutput"></div>
        </div>

        <div class="card-box" id="review-box" style="display:none; border:2px solid #FF9800; margin-top:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">ğŸ–ï¸ ë²ˆë¬¸ ì •ë°€ ë¶„ì„ (ìˆ˜ì •ë³¸ ë¹„êµ)</h3>
                <div style="font-size:0.85rem; display:flex; gap:10px; flex-wrap: wrap;">
                    <span class="hl-success">ì„±ê³µ(ìˆ˜ì •í•¨)</span>
                    <span class="hl-warning">ì˜¤ìˆ˜ì •(í‹€ë¦¼)</span>
                    <span class="hl-bad">ê°œì•…(ë§ì¹¨)</span>
                    <span class="hl-missed">ë¯¸ìˆ˜ì •</span>
                    <span class="hl-omitted">íƒˆì(ë†“ì¹¨)</span>
                </div>
            </div>
            <div class="review-view" id="reviewContent"></div>
            <div style="margin-top:15px; background:#FFF3E0; padding:10px; border-radius:8px; font-size:0.9rem;">
                ğŸ’¡ <b>ë¶„ì„ ê°€ì´ë“œ:</b> 
                <span style="color:#00B894; font-weight:bold;">ì„±ê³µ</span>ì€ í‹€ë¦°ê±¸ ë§ê²Œ ê³ ì¹œ ê²ƒ, 
                <span style="color:#fbc02d; font-weight:bold;">ì˜¤ìˆ˜ì •</span>ì€ ê³ ì³¤ìœ¼ë‚˜ ì—¬ì „íˆ í‹€ë¦° ê²ƒ, 
                <span style="color:#ff5722; font-weight:bold;">ê°œì•…</span>ì€ ë§ì•˜ë˜ê±¸ í‹€ë¦¬ê²Œ ê³ ì¹œ ê²ƒì…ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <div class="card-box" style="background:#FAFAFA; margin-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h4 style="margin:0;">ğŸ“œ ìµœê·¼ ê¸°ë¡ (ì´ˆì•ˆ ê¸°ì¤€)</h4>
            <button onclick="clearHistoryView()" class="btn-ghost" style="font-size:0.8rem;">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>
        <div id="historyList"></div>
    </div>

</main>

<script>
function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

// [ì‹ ê·œ] ëª¨ë“œ ì „í™˜ ê¸°ëŠ¥
function toggleMode() {
    const isChecked = document.getElementById('modeToggle').checked;
    const postSection = document.getElementById('postEditSection');
    const lblPre = document.getElementById('lblPre');
    
    if (isChecked) {
        postSection.classList.add('active');
        lblPre.innerText = "âœï¸ ë‚´ ì…ë ¥ (ì´ˆì•ˆ)"; // ë²ˆë¬¸ ëª¨ë“œ ì‹œ 'ì´ˆì•ˆ'ìœ¼ë¡œ ëª…ì‹œ
    } else {
        postSection.classList.remove('active');
        lblPre.innerText = "âœï¸ ë‚´ ì…ë ¥"; // ì¼ë°˜ ëª¨ë“œ ì‹œ ê·¸ëƒ¥ 'ë‚´ ì…ë ¥'
        document.getElementById('studentPost').value = ""; // ë„ë©´ ë‚´ìš© ì´ˆê¸°í™” (ì„ íƒì‚¬í•­)
    }
}

const GAS_URL = "https://script.google.com/macros/s/AKfycbyy-tcN11MycmXmaQjJ20KhLoOQzDqtr8b6YvwbLyF3OOVywlOzcm2EIkl_h4S9LoEFLQ/exec"; 

let currentUser = sessionStorage.getItem('shorthand_user');
let scoreHistory = [];
let fullHistoryRaw = [];
let myChart = null;
let currentErrorItems = []; 

function escapeHtml(str) {
    return String(str ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}

function toHtmlChar(ch) {
    if (ch === " ") return "&nbsp;";
    return escapeHtml(ch);
}

function initApp() {
    if (!currentUser) {
        alert("ë¡œê·¸ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”! ğŸ™…â€â™€ï¸");
        location.href = 'index.html'; 
        return;
    }
    const welcomeHTML = `ğŸ‘‹ <b>${escapeHtml(currentUser)}</b>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
    document.getElementById('welcomeMsg').innerHTML = welcomeHTML;
    if(document.getElementById('sideUserName')) document.getElementById('sideUserName').innerText = currentUser;
    
    setupDragAndDrop('original');
    setupDragAndDrop('studentPre');
    setupDragAndDrop('studentPost');
    initAudioPlayer();
    fetchData();
}

// ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ë¡œì§
const audio = document.getElementById('audioPlayer');
const playBtn = document.getElementById('playBtn');
const progressBar = document.getElementById('audioProgress');
const timeDisplay = document.getElementById('timeDisplay');
function initAudioPlayer() {
    audio.addEventListener('timeupdate', () => {
        if (!isNaN(audio.duration)) {
            progressBar.value = (audio.currentTime / audio.duration) * 100;
            updateTimeDisplay();
        }
    });
    audio.addEventListener('loadedmetadata', () => { updateTimeDisplay(); playBtn.disabled = false; });
    audio.addEventListener('ended', () => { playBtn.innerText = "â–¶"; progressBar.value = 0; });
}

function loadAudioFile(input) {
    const file = input.files[0];
    if (file) {
        const fileURL = URL.createObjectURL(file);
        audio.src = fileURL;
        playBtn.innerText = "â–¶";
        playBtn.disabled = false;
    }
}

function toggleAudio() {
    if (audio.paused) { audio.play(); playBtn.innerText = "â¸"; } 
    else { audio.pause(); playBtn.innerText = "â–¶"; }
}

function changeSpeed() { audio.playbackRate = parseFloat(document.getElementById('speedRate').value); }
function seekAudio() { audio.currentTime = (progressBar.value / 100) * audio.duration; }
function updateTimeDisplay() {
    const format = (t) => {
        const m = Math.floor(t / 60).toString().padStart(2, '0');
        const s = Math.floor(t % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    };
    timeDisplay.innerText = `${format(audio.currentTime)} / ${format(audio.duration || 0)}`;
}

async function fetchData() {
    try {
        const res = await fetch(`${GAS_URL}?action=getHistory&name=${encodeURIComponent(currentUser)}`);
        const data = await res.json();
        if (data.result === "success") {
            fullHistoryRaw = data.history || [];
            const ignoredCount = parseInt(localStorage.getItem('ignoredHistoryCount') || '0');
            scoreHistory = fullHistoryRaw.slice(ignoredCount);
            updateHistoryUI(); 
            updateChart();
            if(data.allTodayHistory) updateKingRanking(data.allTodayHistory);
            checkAttendance(scoreHistory);
        }
    } catch (e) { console.error("ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜"); }
}

function updateKingRanking(allHistory) {
    const kingListEl = document.getElementById('kingList');
    if (!allHistory || allHistory.length === 0) { kingListEl.innerHTML = "ì—°ìŠµì„ ì‹œì‘í•´ 1ë“±ì´ ë˜ì–´ë³´ì„¸ìš”! ğŸ†"; return; }
    const totals = {};
    allHistory.forEach(h => { totals[h.name] = (totals[h.name] || 0) + Number(h.charCount || 0); });
    const sorted = Object.entries(totals).sort((a, b) => b[1] - a[1]).slice(0, 3);
    kingListEl.innerHTML = sorted.map((s, idx) => {
        let style = (idx === 0) ? "background:var(--gold); border:1px solid white;" : "";
        return `<div class="ranking-item" style="${style}">${idx+1}ë“± ${escapeHtml(s[0])}</div>`;
    }).join('');
}

function clearAllInputs() {
    if(confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?")) {
        document.getElementById('original').value = "";
        document.getElementById('studentPre').value = "";
        document.getElementById('studentPost').value = "";
    }
}

// [í•µì‹¬ ë¡œì§] í†µí•© ë¶„ì„ í•¨ìˆ˜
function analyzeAndGrade() {
    let rawO = document.getElementById('original').value;
    let rawS = document.getElementById('studentPre').value; 
    let rawPost = document.getElementById('studentPost').value;
    // ëª¨ë“œ ì²´í¬
    const isModeOn = document.getElementById('modeToggle').checked;

    if(!rawO.trim()) { alert("ì •ë‹µ(ì›ë³¸)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    if(!rawS.trim()) { alert("ë‚´ ì…ë ¥ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    const isSpecial = (char) => /[^0-9a-zA-Z\uAC00-\uD7A3]/.test(char);
    let pureLength = rawO.replace(/[^0-9a-zA-Z\uAC00-\uD7A3]/g, '').length;

    // 1. ê¸°ë³¸ ì±„ì  (ë˜‘1 ë°©ì‹ - ì›ë³¸ vs ì´ˆì•ˆ)
    let oArr = rawO.trim().split('');
    let sArr = rawS.trim().split('');
    let n = oArr.length;
    let m = sArr.length;
    
    let dp = Array.from(Array(n + 1), () => Array(m + 1).fill(0));
    for (let i = 1; i <= n; i++) {
        for (let j = 1; j <= m; j++) {
            if (oArr[i-1] === sArr[j-1]) dp[i][j] = dp[i-1][j-1] + 1;
            else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
        }
    }

    let i = n, j = m, diffs = [];
    while (i > 0 || j > 0) {
        if (i > 0 && j > 0 && oArr[i-1] === sArr[j-1]) { diffs.push({ t: 'same', c: oArr[i-1] }); i--; j--; } 
        else if (j > 0 && (i === 0 || dp[i][j-1] >= dp[i-1][j])) { diffs.push({ t: 'added', c: sArr[j-1] }); j--; } 
        else { diffs.push({ t: 'missing', c: oArr[i-1] }); i--; }
    }
    diffs.reverse();

    let html = "", w=0, mi=0, ad=0;
    let mBuffer = [], aBuffer = []; 
    currentErrorItems = [];
    let wordO = "", wordS = "", isWordDirty = false;

    function commitWord() {
        if (isWordDirty && (wordO.trim() || wordS.trim())) {
            currentErrorItems.push({ type: (wordS.trim() === "") ? 'missing' : 'wrong', correct: wordO, wrong: wordS });
        }
        wordO = ""; wordS = ""; isWordDirty = false;
    }

    function flushBuffer() {
        let mIdx = 0, aIdx = 0;
        while (mIdx < mBuffer.length || aIdx < aBuffer.length) {
            let mChar = mBuffer[mIdx];
            let aChar = aBuffer[aIdx];

            if (mIdx < mBuffer.length && isSpecial(mChar)) { 
                html += `<span>${toHtmlChar(mChar)}</span>`;
                wordO += mChar; wordS += mChar; mIdx++; continue;
            }
            if (aIdx < aBuffer.length && isSpecial(aChar)) { 
                html += `<span style=\"color:#ccc;\">${toHtmlChar(aChar)}</span>`;
                wordS += aChar; aIdx++; continue; 
            }
            if (mIdx < mBuffer.length && aIdx < aBuffer.length) { 
                html += `<span class=\"d-wrong\">${toHtmlChar(aChar)}<span class=\"correction\">${toHtmlChar(mChar)}</span></span>`;
                wordO += mChar; wordS += aChar; isWordDirty = true; w++; mIdx++; aIdx++; continue;
            }
            if (mIdx < mBuffer.length) { 
                html += `<span class=\"d-missing\">${toHtmlChar(mChar)}</span>`;
                wordO += mChar; isWordDirty = true; mi++; mIdx++; continue;
            }
            if (aIdx < aBuffer.length) { 
                html += `<span class=\"d-added\">${toHtmlChar(aChar)}</span>`;
                wordS += aChar; isWordDirty = true; ad++; aIdx++; continue;
            }
        }
        mBuffer = []; aBuffer = [];
    }

    for (let k = 0; k < diffs.length; k++) {
        let item = diffs[k];
        if (item.t === 'same') { 
            flushBuffer();
            if (item.c === ' ' || item.c === '\n') {
                commitWord();
                html += (item.c === ' ') ? '<span>&nbsp;</span>' : '<br>';
            } else {
                html += `<span>${toHtmlChar(item.c)}</span>`;
                wordO += item.c; wordS += item.c;
            }
        } 
        else if (item.t === 'missing') { mBuffer.push(item.c); } 
        else if (item.t === 'added') { aBuffer.push(item.c); }
    }
    flushBuffer(); commitWord(); 

    let adPenalty = Math.floor(ad / 3);
    let calcN = pureLength > 0 ? pureLength : 1;
    let score = Math.max(0, 100 - ((w + mi + adPenalty) / calcN * 100)).toFixed(1);
    const fName = document.getElementById('fileName').value.trim() || "ë¯¸ì§€ì •";

    analyzeGrowth(score, w + mi + ad, fName);
    document.getElementById('finalScore').innerText = score;
    document.getElementById('scoreDesc').innerText = `ì´ ê¸€ì(ë¶€í˜¸ì œì™¸): ${pureLength} / ì˜¤ì: ${w} / íƒˆì: ${mi} / ì²¨ì: ${ad}`;
    document.getElementById('diffOutput').innerHTML = html;
    
    renderErrorNote();
    document.getElementById('result').style.display = 'block';

    sendDataToServer(score, w, mi, ad, fName, pureLength);

    // 2. ê³ ê¸‰ ë¶„ì„ (ë˜‘2 ë°©ì‹ - ìˆ˜ì •ë³¸ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰)
    if (isModeOn && rawPost.trim()) {
        document.getElementById('review-box').style.display = 'block';
        generateCorrectionHighlight(rawO, rawS, rawPost);
    } else {
        document.getElementById('review-box').style.display = 'none';
    }
}

// [ì‹ ê·œ] ë²ˆë¬¸ ì •ë°€ ë¶„ì„ ë¡œì§ í•¨ìˆ˜
function generateCorrectionHighlight(txtOriginal, txtPre, txtPost) {
    const cleanO = txtOriginal.replace(/\s+/g, ' ').trim();
    const sOrigin = txtOriginal.trim().split('');
    const sPre = txtPre.trim().split('');
    const sPost = txtPost.trim().split('');
    const getDiff = (arr1, arr2) => {
        let dp = Array.from(Array(arr1.length + 1), () => Array(arr2.length + 1).fill(0));
        for (let i = 1; i <= arr1.length; i++) {
            for (let j = 1; j <= arr2.length; j++) {
                if (arr1[i-1] === arr2[j-1]) dp[i][j] = dp[i-1][j-1] + 1;
                else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
            }
        }
        let i = arr1.length, j = arr2.length;
        let diff = [];
        while (i > 0 || j > 0) {
            if (i > 0 && j > 0 && arr1[i-1] === arr2[j-1]) { diff.push({ t: 'same', c: arr1[i-1] }); i--; j--; }
            else if (j > 0 && (i === 0 || dp[i][j-1] >= dp[i-1][j])) { diff.push({ t: 'added', c: arr2[j-1] }); j--; }
            else { diff.push({ t: 'missing', c: arr1[i-1] }); i--; }
        }
        return diff.reverse();
    };

    const diffPrePost = getDiff(sPre, sPost);
    let postMeta = [];
    let delQueue = [];
    diffPrePost.forEach(ch => {
        if (ch.t === 'same') { delQueue = []; postMeta.push({ isNew: false, deletedFromPre: "" }); }
        else if (ch.t === 'missing') { delQueue.push(ch.c); }
        else if (ch.t === 'added') { let matchedDel = delQueue.shift() || ""; postMeta.push({ isNew: true, deletedFromPre: matchedDel }); }
    });

    const diffOrigPost = getDiff(sOrigin, sPost);
    let html = "";
    let postIdx = 0; let missingBuffer = "";

    const flushMissing = () => {
        if (!missingBuffer) return;
        for (let char of missingBuffer) {
            if (char === '\n') html += '<br>';
            else if (char === ' ') html += '<span>&nbsp;</span>'; 
            else html += `<span class="hl-omitted">${escapeHtml(char)}</span>`;
        }
        missingBuffer = "";
    };
    diffOrigPost.forEach(ch => {
        if (ch.t === 'same') {
            flushMissing();
            let displayChar = (ch.c === '\n') ? '<br>' : `<span>${toHtmlChar(ch.c)}</span>`;
            let meta = postMeta[postIdx] || { isNew: false };
            if (meta.isNew) {
                if (!/^\s$/.test(ch.c)) html += `<span class="hl-success">${toHtmlChar(ch.c)}</span>`;
                else html += displayChar;
            } else {
                html += displayChar;
            }
            postIdx++;
        } else if (ch.t === 'missing') {
            missingBuffer += ch.c;
        } else if (ch.t === 'added') {
            let targetChar = ch.c;
            let displayChar = toHtmlChar(targetChar);
            if (targetChar === '\n') displayChar = '<br>';
            if (/^\s$/.test(targetChar)) {
                html += displayChar;
            } else {
                let meta = postMeta[postIdx] || { isNew: true, deletedFromPre: "" };
                if (meta.isNew) {
                    let deletedText = meta.deletedFromPre.trim();
                    if (deletedText.length > 0 && cleanO.includes(deletedText)) { html += `<span class="hl-bad">${displayChar}</span>`; } 
                    else if (deletedText.length === 0) { html += `<span class="hl-bad">${displayChar}</span>`; }
                    else { html += `<span class="hl-warning">${displayChar}</span>`; }
                } else {
                    html += `<span class="hl-missed">${displayChar}</span>`;
                }
            }
            missingBuffer = "";
            postIdx++;
        }
    });
    flushMissing();
    document.getElementById('reviewContent').innerHTML = html;
}

function renderErrorNote() {
    const area = document.getElementById('errorNoteArea');
    const list = document.getElementById('errorList');
    const icon = document.getElementById('errorToggleIcon');
    const validErrors = currentErrorItems.filter(e => e.correct.trim().length > 0 || e.wrong.trim().length > 0);
    if (validErrors.length === 0) { area.style.display = 'none'; return; }

    list.innerHTML = validErrors.map(e => {
        if(e.type === 'wrong') {
            return `
            <div class="error-item-row">
                <span style="background:#FF7675; color:white; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin-right:5px;">ì˜¤ì</span>
                <span style="color:#FF7675; text-decoration:line-through; margin-right:5px;">${escapeHtml(e.wrong)}</span>
                <span style="color:#6C5CE7; font-weight:bold;">â¡ ${escapeHtml(e.correct)}</span>
            </div>`;
        } else {
            return `
            <div class="error-item-row">
                <span style="background:#B2BEC3; color:white; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin-right:5px;">íƒˆì</span>
                <span style="color:#B2BEC3;">(ëˆ„ë½ë¨)</span>
                <span style="color:#6C5CE7; font-weight:bold;">â¡ ${escapeHtml(e.correct)}</span>
            </div>`;
        }
    }).join('');
    area.style.display = 'block'; list.style.display = 'none'; 
    icon.innerText = `â–¼ (ì´ ${validErrors.length}ê°œ - í´ë¦­í•´ì„œ í¼ì¹˜ê¸°)`;
}

function toggleErrorList() {
    const list = document.getElementById('errorList');
    const icon = document.getElementById('errorToggleIcon');
    if (list.style.display === 'none') {
        list.style.display = 'block'; icon.innerText = 'â–² (ì ‘ê¸°)';
    } else {
        list.style.display = 'none';
        const count = currentErrorItems.filter(e => e.correct.trim().length > 0 || e.wrong.trim().length > 0).length;
        icon.innerText = `â–¼ (ì´ ${count}ê°œ - í´ë¦­í•´ì„œ í¼ì¹˜ê¸°)`;
    }
}

function saveErrorNote() {
    if (currentErrorItems.length === 0) { alert("ì €ì¥í•  ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    const fName = document.getElementById('fileName').value.trim() || "ì—°ìŠµ";
    const today = new Date().toISOString().slice(0, 10);
    let content = `[${today}] ${fName} - ì˜¤ë‹µ ë…¸íŠ¸ (ë‹¨ì–´ ë‹¨ìœ„)\n\n`;
    content += currentErrorItems.map((e, i) => {
        if (e.type === 'wrong') return `${i+1}. [ì˜¤ì] ì…ë ¥: '${e.wrong}' -> ì •ë‹µ: '${e.correct}'`;
        else return `${i+1}. [íƒˆì] ë†“ì¹œ ë‚´ìš©: '${e.correct}'`;
    }).join('\n');
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${fName}_ì˜¤ë‹µë…¸íŠ¸_${today}.txt`;
    link.click();
}

function analyzeGrowth(currentScore, currentErrors, fileName) {
    const box = document.getElementById('growthBox');
    if (!fileName || fileName === "ë¯¸ì§€ì •") { box.style.display = 'none'; return; }
    const prevRecords = fullHistoryRaw.filter(h => h.title === fileName);
    if (prevRecords.length === 0) {
        box.innerHTML = `<div class="growth-title">ğŸŒ± ì²« ë„ì „ì´ë„¤ìš”!</div><div>'${escapeHtml(fileName)}' íŒŒì¼ì˜ ì²« ê¸°ë¡ì´ ìƒì„±ë©ë‹ˆë‹¤. ê¸°ì¤€ ê¸°ë¡ì„ ì˜ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>`;
        box.style.display = 'block';
    } else {
        const last = prevRecords[prevRecords.length - 1];
        const lastScore = parseFloat(last.score);
        const lastErrors = parseInt(last.w) + parseInt(last.mi) + parseInt(last.ad);
        const cScore = parseFloat(currentScore);
        const scoreDiff = (cScore - lastScore).toFixed(1);
        const errDiff = lastErrors - currentErrors;
        let msg = `<div class="growth-title">ğŸ†š '${escapeHtml(fileName)}' ì„±ì¥ ë¶„ì„</div>`;
        if (cScore > lastScore) msg += `<div style="margin-bottom:5px;">ğŸš€ ì ìˆ˜ê°€ <span style="color:#00B894; font-weight:bold;">+${scoreDiff}ì </span> ì˜¬ëì–´ìš”! (ì§ì „: ${lastScore}ì )</div>`;
        else if (cScore < lastScore) msg += `<div style="margin-bottom:5px;">ğŸ“‰ ì ìˆ˜ê°€ <span style="color:#FF7675; font-weight:bold;">${scoreDiff}ì </span> ë–¨ì–´ì¡Œì–´ìš”. ë‹¤ì‹œ ì§‘ì¤‘í•´ë´ìš”! (ì§ì „: ${lastScore}ì )</div>`;
        else msg += `<div style="margin-bottom:5px;">âš–ï¸ ì§€ë‚œë²ˆê³¼ ì ìˆ˜ê°€ ë˜‘ê°™ì•„ìš”. (${lastScore}ì )</div>`;
        
        if (errDiff > 0) msg += `<div>âœ¨ ì™€ìš°! ì „ì²´ ì‹¤ìˆ˜(ì˜¤/íƒˆ/ì²¨)ê°€ <span style="color:#00B894; font-weight:bold;">${errDiff}ê°œ</span> ì¤„ì—ˆì–´ìš”!</div>`;
        else if (errDiff < 0) msg += `<div>âš ï¸ ì‹¤ìˆ˜ê°€ ì§€ë‚œë²ˆë³´ë‹¤ <span style="color:#FF7675; font-weight:bold;">${Math.abs(errDiff)}ê°œ</span> ëŠ˜ì–´ë‚¬ì–´ìš”.</div>`;
        box.innerHTML = msg; box.style.display = 'block';
    }
}

async function sendDataToServer(score, w, mi, ad, title, n) {
    const scoreNum = parseFloat(score);
    const today = new Date().toISOString().slice(0, 10);
    const prevMax = Math.max(0, ...scoreHistory.map(h => parseFloat(h.score) || 0));
    scoreHistory.push({ date: today, title: title, score: scoreNum, w: w, mi: mi, ad: ad, n: n });
    fullHistoryRaw.push({ date: today, title: title, score: scoreNum, w: w, mi: mi, ad: ad, n: n });
    
    updateHistoryUI(); updateChart();
    const recordMsg = document.getElementById("recordMsg");
    if (recordMsg && scoreNum > prevMax) {
        recordMsg.innerHTML = `ğŸ… <b>ì‹ ê¸°ë¡!</b> ìµœê³  ì •í™•ë„ ${scoreNum}% ë‹¬ì„±`;
        recordMsg.style.display = "block"; setTimeout(() => (recordMsg.style.display = "none"), 2500);
    }
    const target = parseFloat(document.getElementById("targetScore")?.value || "0");
    const streakMsg = document.getElementById("streakMsg");
    if (streakMsg && target > 0) {
        streakMsg.innerHTML = (scoreNum >= target) ?
        `âœ… <b>ëª©í‘œ ë‹¬ì„±</b> (${target}%)` : `ğŸ“Œ ëª©í‘œ ${target}%ê¹Œì§€ ${Math.max(0, (target - scoreNum)).toFixed(1)}% ë‚¨ìŒ`;
        streakMsg.style.display = "block";
        setTimeout(() => (streakMsg.style.display = "none"), 2500);
    }

  try {
        const res = await fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify({ action: "save", name: currentUser, date: today, title: title, score: scoreNum, w: w, mi: mi, ad: ad, n: n })
        });
        const data = await res.json();
        if (data && data.result === "success") {
            if (Array.isArray(data.history)) { 
                fullHistoryRaw = data.history;
                const ignoredCount = parseInt(localStorage.getItem('ignoredHistoryCount') || '0');
                scoreHistory = fullHistoryRaw.slice(ignoredCount);
                updateHistoryUI(); updateChart();
            }
            if (data.allTodayHistory) updateKingRanking(data.allTodayHistory);
        }
    } catch (e) { console.error("ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜:", e); }
}

function updateHistoryUI() {
    const list = document.getElementById('historyList');
    list.innerHTML = scoreHistory.slice(-10).reverse().map(item => `
        <div style="padding:15px; border-bottom:1px solid #eee;">
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:5px;">
                <span>ğŸ“… ${item.date} [${escapeHtml(item.title)}]</span>
                <span style="color:var(--primary);">${item.score}%</span>
            </div>
            <div style="font-size:0.8rem; color:#888;">
                ğŸ“ ê¸€ì: ${item.n} | âŒ ì˜¤ì: ${item.w} | ğŸ•³ï¸ íƒˆì: ${item.mi} | â• ì²¨ì: ${item.ad}
            </div>
        </div>
    `).join('');
}

function updateChart() {
    const ctx = document.getElementById('scoreChart').getContext('2d');
    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: scoreHistory.slice(-15).map((_, i) => (i+1) + "íšŒ"),
            datasets: [{ 
                label: 'ì •í™•ë„ (%)', 
                data: scoreHistory.slice(-15).map(i => parseFloat(i.score)), 
                borderColor: '#6C5CE7', tension: 0.3, fill: true, backgroundColor: 'rgba(108, 92, 231, 0.1)' 
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function checkAttendance(history) {
    if(!history || history.length === 0) return;
    const dates = [...new Set(history.map(h => h.date))].sort().reverse();
    if(dates.length > 1) {
        const msg = document.getElementById('streakMsg');
        msg.innerHTML = `ğŸ”¥ <b>ê¾¸ì¤€í•¨ì˜ ìŠ¹ë¦¬!</b> ì—°ì†ìœ¼ë¡œ ì—°ìŠµì„ ì´ì–´ê°€ê³  ìˆìŠµë‹ˆë‹¤!`;
        msg.style.display = 'block';
    }
}

function logout() { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { sessionStorage.clear(); location.href = 'index.html'; } }

function clearHistoryView() {
    if(confirm("ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.setItem('ignoredHistoryCount', fullHistoryRaw.length);
        scoreHistory = []; updateHistoryUI(); updateChart(); alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨");
    }
}

function closeReport() { document.getElementById('overlay').style.display = 'none'; document.getElementById('report-modal').style.display = 'none'; }
function generateReport() {
    if (!scoreHistory || scoreHistory.length === 0) { alert("ë¶„ì„í•  ì—°ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì—°ìŠµì„ ì§„í–‰í•´ ì£¼ì„¸ìš”!"); return; }
    const now = new Date();
    const thisMonth = now.getMonth(); const thisYear = now.getFullYear();
    const monthlyData = scoreHistory.filter(h => { const hDate = new Date(h.date); return hDate.getMonth() === thisMonth && hDate.getFullYear() === thisYear; });
    if (monthlyData.length === 0) { alert("ì´ë²ˆ ë‹¬ ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

    const totalSessions = monthlyData.length;
    const avgScore = (monthlyData.reduce((acc, cur) => acc + parseFloat(cur.score), 0) / totalSessions).toFixed(1);
    const totalChars = monthlyData.reduce((acc, cur) => acc + parseInt(cur.n || 0), 0);
    const maxScore = Math.max(...monthlyData.map(h => parseFloat(h.score)));
    const reportHtml = `
        <div style="background:#F0F4F8; padding:15px; border-radius:10px; border-left:5px solid var(--primary); margin-bottom:15px;">
            <p style="margin:5px 0;">ğŸ“Š <b>ì´ ì—°ìŠµ íšŸìˆ˜:</b> ${totalSessions}íšŒ</p>
            <p style="margin:5px 0;">ğŸ¯ <b>í‰ê·  ì •í™•ë„:</b> <span style="color:var(--primary); font-weight:bold;">${avgScore}%</span></p>
            <p style="margin:5px 0;">ğŸ† <b>ìµœê³  ì •í™•ë„:</b> ${maxScore}%</p>
            <p style="margin:5px 0;">âŒ¨ï¸ <b>ëˆ„ì  ì—°ìŠµëŸ‰:</b> ${totalChars.toLocaleString()}ì</p>
        </div>
        <p style="text-align:center; font-size:14px; color:#666;">
            ${avgScore >= 98 ? "ğŸŒŸ ì „ë¬¸ê°€ ìˆ˜ì¤€ì˜ ì •í™•ë„ì…ë‹ˆë‹¤!" : "ğŸ“ˆ ê¾¸ì¤€íˆ ì—°ìŠµí•˜ë©´ ë” ì¢‹ì•„ì§ˆ ê±°ì˜ˆìš”!"}
        </p>
    `;
    document.getElementById('report-content').innerHTML = reportHtml;
    document.getElementById('overlay').style.display = 'block'; document.getElementById('report-modal').style.display = 'block';
}

function loadFile(input, targetId) {
    const file = input.files[0];
    if (file) readFile(file, targetId);
}

function readFile(file, targetId) {
    if (file.name.split('.').pop().toLowerCase() !== 'txt') { alert("txt íŒŒì¼ë§Œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”! ğŸ˜…"); return; }
    const reader = new FileReader();
    reader.onload = function(e) { document.getElementById(targetId).value = e.target.result; };
    reader.readAsText(file, "UTF-8");
}

function setupDragAndDrop(areaId) {
    const area = document.getElementById(areaId);
    area.addEventListener("dragover", (e) => { e.preventDefault(); area.style.borderColor = "var(--primary)"; });
    area.addEventListener("dragleave", (e) => { e.preventDefault(); area.style.borderColor = "#F0F4F8"; });
    area.addEventListener("drop", (e) => { e.preventDefault(); area.style.borderColor = "#F0F4F8"; const file = e.dataTransfer.files[0]; if (file) readFile(file, areaId); });
}

function saveScreenshot() {
    const element = document.getElementById("result-card-box");
    if (!element) { alert("ì €ì¥í•  ê²°ê³¼ í™”ë©´ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    html2canvas(element, { scale: 2, backgroundColor: "#ffffff", useCORS: true }).then(canvas => {
        const link = document.createElement("a");
        const today = new Date().toISOString().slice(0, 10);
        const fName = document.getElementById('fileName').value.trim() || "ì—°ìŠµ";
        link.download = `ë˜‘ì†Œë¦¬_${fName}_ê²°ê³¼_${today}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
}
</script>
</body>
</html>
