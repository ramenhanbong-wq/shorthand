<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHORTHAND PRO - ë˜‘ì†Œë¦¬ 2 (ë²ˆë¬¸ ì •ë°€ ë¶„ì„)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --bg-body: #F0F4F8;
            --sidebar-bg: #F8F9FA;
            --primary: #6C5CE7; 
            --primary-light: #A29BFE;
            --text-dark: #2D3436; 
            --text-grey: #636E72;
            --white: #FFFFFF;
            --shadow-card: 0 4px 20px rgba(0,0,0,0.03);
            --radius-card: 24px;
            --success: #00B894; 
            --fail: #FF7675; 
            --warn: #FAB1A0;
            --gold: #FD79A8;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background: var(--bg-body);
            color: var(--text-dark); margin: 0; padding: 0; 
            display: flex; height: 100vh; overflow: hidden;
        }

        /* [ëª¨ë°”ì¼ ì „ìš© ë²„íŠ¼] */
        .mobile-menu-btn {
            display: none;
            position: fixed; top: 15px; left: 15px; z-index: 1001;
            background: var(--primary); color: white; border: none;
            border-radius: 8px; padding: 8px 12px;
            font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .sidebar-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(3px);
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg); padding: 30px 20px; 
            display: flex; flex-direction: column; border-right: 2px solid #E1E4E8;
            flex-shrink: 0; z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.03);
            transition: transform 0.3s ease;
        }
        .logo { font-size: 1.4rem;
            font-weight: 900; color: var(--primary); margin-bottom: 40px; padding-left: 10px; }
        
        .nav-list { list-style: none;
            padding: 0; margin: 0; flex: 1; }
        .nav-item {
            padding: 14px 18px;
            margin-bottom: 12px; border-radius: 14px;
            color: var(--text-grey); font-weight: 700; cursor: pointer; text-decoration: none;
            display: flex; align-items: center; gap: 12px; transition: 0.2s;
            background: white; border: 1px solid #EAEAEA; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .nav-item:hover, .nav-item.active { 
            background: var(--primary);
            color: white; border-color: var(--primary);
            transform: translateY(-2px); box-shadow: 0 4px 8px rgba(108, 92, 231, 0.3);
        }
        .nav-icon { width: 24px; text-align: center;
        }

        .profile-card {
            background: white;
            padding: 15px; border-radius: 16px;
            display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.3s; margin-top: auto;
            border: 1px solid #EAEAEA;
        }
        .profile-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            flex: 1;
            padding: 40px 50px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
        }
        
        .page-header { display: flex;
            justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .page-title h2 { font-size: 1.8rem;
            font-weight: 800; margin: 0; color: var(--text-dark); }
        .page-title p { color: var(--text-grey);
            margin: 5px 0 0 0; }

        .card-box {
            background: var(--white);
            border-radius: var(--radius-card); padding: 30px;
            box-shadow: var(--shadow-card); transition: 0.3s;
            border: 1px solid #DCE0E5;
            margin-bottom: 20px;
        }

        .ranking-banner {
            background: linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%);
            color: white; padding: 20px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 20px rgba(108, 92, 231, 0.2); margin-bottom: 20px;
            border: 2px solid white; outline: 2px solid #a29bfe;
        }
        .ranking-list { display: flex;
            justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .ranking-item { padding: 5px 12px;
            border-radius: 20px; font-weight: 700; font-size: 0.9rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
        }

        .config-row { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .config-item { flex: 1; display: flex; flex-direction: column; gap: 8px;
        }
        .styled-input {
            padding: 12px 15px;
            border: 2px solid #E1E4E8; border-radius: 12px;
            font-size: 1rem; outline: none; transition: 0.2s; background: #F8F9FA;
        }
        .styled-input:focus { border-color: var(--primary); background: #fff;
        }

        .audio-player-card { 
            background: #F8F9FA;
            border-radius: 20px; padding: 20px; 
            border: 1px solid #E1E4E8;
        }
        .play-btn-circle {
            width: 50px;
            height: 50px; border-radius: 50%; background: var(--primary); color: white;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3); transition: 0.2s;
        }
        .play-btn-circle:hover { transform: scale(1.1);
        }
        .play-btn-circle:disabled { background: #ddd; box-shadow: none; cursor: not-allowed;
        }
        
        .progress-container input[type="range"] { width: 100%;
            cursor: pointer; accent-color: var(--primary); }
        .time-wrapper { font-size: 0.85rem; color: #888; font-weight: 600;
            text-align: right; margin-top: 5px; }

        /* [ìˆ˜ì •ë¨] ì…ë ¥ì°½ ë ˆì´ì•„ì›ƒ ê°œì„  (ìƒë‹¨1, í•˜ë‹¨2) */
        .input-layout { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        .input-row-top { width: 100%; }
        .input-row-bottom { display: flex; gap: 20px; }
        .input-col-half { flex: 1; display: flex; flex-direction: column; gap: 10px; }

        .styled-textarea {
            width: 100%;
            height: 300px; /* ë†’ì´ ì¦ê°€ */ 
            padding: 20px; 
            border: 2px solid #E1E4E8; border-radius: 16px;
            resize: none; font-size: 1.1rem; line-height: 1.8; box-sizing: border-box; outline: none;
            transition: 0.2s;
            font-family: 'Pretendard', sans-serif; background: #FFFEFC;
        }
        .styled-textarea:focus { border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1); background: white;
        }
        .label-badge { display: inline-block; background: #EEEBFF; color: var(--primary); padding: 5px 12px;
            border-radius: 8px; font-weight: 800; font-size: 0.9rem; border: 1px solid #D1C4E9;
        }

        .btn-primary {
            background: var(--primary);
            color: white; border: none; padding: 15px 30px;
            border-radius: 16px; font-size: 1.1rem; font-weight: 800; cursor: pointer;
            width: 100%; margin-top: 20px;
            transition: 0.2s; box-shadow: 0 10px 20px rgba(108, 92, 231, 0.2);
            border: 2px solid transparent;
        }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(108, 92, 231, 0.3);
            border-color: #A29BFE; }

        .btn-ghost { background: #fff; border: 2px solid #E1E4E8;
            padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666; transition: 0.2s;
        }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary);
        }

        /* ì¼ë°˜ Diff ë·° */
        .diff-view { 
            background: #fff;
            padding: 25px; border: 2px solid #E1E4E8; border-radius: 16px; 
            font-size: 18px; line-height: 2.2; white-space: pre-wrap; word-break: break-all;
        }
        .d-missing { background: #FFEBEE; color: #FF7675; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        .d-added { color: #00B894; font-weight: bold; text-decoration: underline; }
        .d-wrong { border-bottom: 2px solid var(--primary); position: relative; font-weight: bold; color: var(--primary); }
        .correction { 
            position: absolute; top: -1.4em; left: 0; font-size: 0.8em; line-height: 1;
            color: white; background: var(--primary); padding: 3px 6px; border-radius: 5px; white-space: nowrap;
        }

        /* [ì‹ ê·œ] ë²ˆë¬¸ ë¶„ì„ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .review-view { 
            background: #fff; line-height: 2.5; font-size: 1.1rem; color: #333;
        }
        /* ì„±ê³µ: í‹€ë¦°ê±¸ ë§ì¶¤ (ì´ˆë¡ í˜•ê´‘íœ) */
        .hl-success { background: #b2fab4; border-bottom: 2px solid #00B894; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        /* ì˜¤ìˆ˜ì •: ê³ ì³¤ëŠ”ë° í‹€ë¦¼ (ë…¸ë€ í˜•ê´‘íœ) */
        .hl-warning { background: #fff59d; border-bottom: 2px solid #fbc02d; padding: 2px 4px; border-radius: 4px; }
        /* ê°œì•…: ë§ì€ê±¸ í‹€ë¦¬ê²Œ ê³ ì¹¨ (ì£¼í™© í˜•ê´‘íœ) */
        .hl-bad { background: #ffccbc; border-bottom: 2px solid #ff5722; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        /* ë¯¸ìˆ˜ì •: ì—¬ì „íˆ í‹€ë¦¼ (ë¹¨ê°„ í…ìŠ¤íŠ¸) */
        .hl-missed { color: #d32f2f; text-decoration: underline; text-decoration-style: wavy; }

        .growth-box { background: #E3F2FD; color: #1565C0; padding: 20px; border-radius: 16px; margin-bottom: 20px;
            display: none; border: 2px solid #90CAF9; }
        .growth-title { font-weight: 800; font-size: 1.1rem; margin-bottom: 8px; display: block; }

        .toast-msg { 
            position: fixed;
            top: 20px; left: 50%; transform: translateX(-50%); 
            background: var(--text-dark); color: white; padding: 12px 25px; border-radius: 30px; 
            font-weight: bold; z-index: 2000;
            display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }

        .modal-overlay { display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; backdrop-filter: blur(5px);
        }
        #report-modal { 
            display: none;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 400px; background: white; padding: 30px; border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 2001; 
            border: 1px solid #E1E4E8;
        }

        /* [ëª¨ë°”ì¼ ëŒ€ì‘] */
        @media (max-width: 768px) {
            body { overflow: auto; }
            .sidebar { position: fixed; top: 0; left: 0;
            height: 100%; transform: translateX(-100%); box-shadow: 2px 0 15px rgba(0,0,0,0.1); }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .mobile-menu-btn { display: block; }
            
            .main-content { padding: 70px 20px 20px; width: 100%; box-sizing: border-box; }
            /* ëª¨ë°”ì¼ì—ì„œ ì…ë ¥ì°½ ì„¸ë¡œ ë°°ì¹˜ */
            .input-row-bottom { flex-direction: column; }
            .card-box { padding: 20px; }
        }
    </style>
</head>
<body onload="initApp()">

<button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="streakMsg" class="toast-msg"></div> 
<div id="recordMsg" class="toast-msg" style="background:var(--success);"></div>

<div class="modal-overlay" id="overlay" onclick="closeReport()"></div>
<div id="report-modal">
    <h2 style="text-align:center; color:var(--text-dark); margin-top:0;">ğŸ“… ì´ë‹¬ì˜ í•™ìŠµ ë¦¬í¬íŠ¸</h2>
    <div id="report-content" style="line-height: 2; font-size: 1rem; color:#555;"></div>
    <button onclick="closeReport()" class="btn-primary" style="margin-top:20px; padding:12px;">ë‹«ê¸°</button>
</div>

<nav class="sidebar">
    <div class="logo">âš¡ SHORTHAND</div>
    <ul class="nav-list">
        <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ</a>
        <a href="toksori2.html" class="nav-item active"><span class="nav-icon">ğŸ“</span> ë˜‘ì†Œë¦¬ 2</a>
        <a href="king.html" class="nav-item"><span class="nav-icon">ğŸ‘‘</span> íƒ€ìì™•</a>
        </ul>
    <div class="profile-card" onclick="logout()">
        <div style="width:35px; height:35px; background:#D6A2E8; border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">U</div>
        <div>
            <div style="font-weight:700; font-size:0.9rem;" id="sideUserName">User</div>
            <div style="font-size:0.75rem; color:#888;">ë¡œê·¸ì•„ì›ƒ</div>
        </div>
    </div>
</nav>

<main class="main-content" id="capture-area">
    <div class="page-header">
        <div class="page-title">
            <h2>ğŸ“ ë˜‘ì†Œë¦¬ 2 (ë²ˆë¬¸ ì •ë°€ë¶„ì„)</h2>
            <p id="welcomeMsg">ì˜¤ëŠ˜ë„ í™”ì´íŒ…í•˜ì„¸ìš”!</p>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="generateReport()" class="btn-ghost">ğŸ“Š ì›”ê°„ ë¦¬í¬íŠ¸</button>
            <button onclick="logout()" class="btn-ghost" style="color:var(--fail); border-color:var(--fail);">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="ranking-banner">
        <div style="font-size:1.1rem; font-weight:800;">ğŸ‘‘ ì‹¤ì‹œê°„ ì—°ìŠµì™• TOP 3</div>
        <div class="ranking-list" id="kingList">ë¶„ì„ ì¤‘...</div>
    </div>

    <div class="card-box">
        <div class="config-row">
            <div class="config-item" style="flex:2;">
                <label style="font-weight:700; font-size:0.9rem;">ğŸ“‚ íŒŒì¼ëª…</label>
                <input type="text" id="fileName" class="styled-input" placeholder="ì˜ˆ: ì—°ì„¤ë¬¸_01">
            </div>
            <div class="config-item" style="flex:1;">
                <label style="font-weight:700; font-size:0.9rem;">ğŸ¯ ëª©í‘œ ì ìˆ˜</label>
                <input type="number" id="targetScore" class="styled-input" value="90">
            </div>
        </div>

        <div class="audio-player-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span style="font-weight:700; color:#555;">ğŸ§ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´</span>
                <label class="btn-ghost" style="font-size:0.8rem; padding:5px 10px; background:white;">
                    ğŸ“‚ ì—´ê¸° <input type="file" accept="audio/*" style="display:none;" onchange="loadAudioFile(this)">
                </label>
            </div>
            <audio id="audioPlayer" style="display:none;"></audio>
            <div style="display:flex; align-items:center; gap:20px;">
                <button id="playBtn" class="play-btn-circle" onclick="toggleAudio()" disabled>â–¶</button>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <select id="speedRate" onchange="changeSpeed()" style="border:none; background:transparent; font-weight:bold; cursor:pointer;">
                            <option value="0.8">0.8x</option>
                            <option value="1.0" selected>1.0x</option>
                            <option value="1.2">1.2x</option>
                        </select>
                        <div id="timeDisplay" class="time-wrapper" style="margin:0;">00:00 / 00:00</div>
                    </div>
                    <div class="progress-container">
                        <input type="range" id="audioProgress" value="0" step="0.1" oninput="seekAudio()">
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align:right; margin-top:20px;">
            <button onclick="clearAllInputs()" class="btn-ghost" style="font-size:0.8rem; color:#888;">ğŸ—‘ï¸ ë‚´ìš© ë¹„ìš°ê¸°</button>
        </div>

        <div class="input-layout">
            <div class="input-row-top">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span class="label-badge">ğŸ“„ ì •ë‹µ(ì›ë³¸)</span>
                    <label style="cursor:pointer; font-size:0.8rem; font-weight:bold; color:var(--primary);">
                        ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° <input type="file" accept=".txt" style="display:none;" onchange="loadFile(this, 'original')">
                    </label>
                </div>
                <textarea id="original" class="styled-textarea" placeholder="ì •ë‹µ í…ìŠ¤íŠ¸ë¥¼ ì´ê³³ì— ì…ë ¥í•˜ì„¸ìš”."></textarea>
            </div>

            <div class="input-row-bottom">
                <div class="input-col-half">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="label-badge" style="background:#ECEFF1; color:#546E7A; border-color:#CFD8DC;">1ï¸âƒ£ ë²ˆë¬¸ ì „ (ì´ˆì•ˆ)</span>
                        <label style="cursor:pointer; font-size:0.8rem; font-weight:bold; color:var(--primary);">
                            ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° <input type="file" accept=".txt" style="display:none;" onchange="loadFile(this, 'studentPre')">
                        </label>
                    </div>
                    <textarea id="studentPre" class="styled-textarea" placeholder="ë‚­ë… ì§í›„ ì‘ì„±í•œ(ìˆ˜ì • ì „) ë‚´ìš©ì…ë‹ˆë‹¤. (í•„ìˆ˜)"></textarea>
                </div>
                <div class="input-col-half">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="label-badge" style="background:#FFF3E0; color:#FF9800; border-color:#FFE0B2;">2ï¸âƒ£ ë²ˆë¬¸ í›„ (ìµœì¢…) - ì„ íƒ</span>
                        <label style="cursor:pointer; font-size:0.8rem; font-weight:bold; color:var(--primary);">
                            ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° <input type="file" accept=".txt" style="display:none;" onchange="loadFile(this, 'studentPost')">
                        </label>
                    </div>
                    <textarea id="studentPost" class="styled-textarea" placeholder="ìˆ˜ì • ì‹œê°„ í›„ì˜ ìµœì¢… ë‹µì•ˆì…ë‹ˆë‹¤. (ì„ íƒì‚¬í•­)"></textarea>
                </div>
            </div>
        </div>

        <button onclick="analyzeAndGrade()" class="btn-primary">ğŸ’¯ ì±„ì í•˜ê¸°</button>
    </div>

    <div id="result" style="display:none;">
        
        <div class="card-box" id="result-pre">
            <h3 style="margin-top:0;">ğŸ“Š [ë²ˆë¬¸ ì „] ì±„ì  ê²°ê³¼</h3>
            <div style="display:flex; gap:20px; align-items:center; margin-bottom:15px;">
                <div style="font-size:3rem; font-weight:900; color:var(--primary);" id="finalScorePre">0</div>
                <div id="scoreDescPre" style="color:#666;"></div>
            </div>
            <div class="diff-view" id="diffOutputPre"></div>
        </div>

        <div class="card-box" id="result-post" style="display:none;">
            <h3 style="margin-top:0; color:#E65100;">ğŸ“Š [ë²ˆë¬¸ í›„] ìµœì¢… ê²°ê³¼</h3>
            <div style="display:flex; gap:20px; align-items:center; margin-bottom:15px;">
                <div style="font-size:3rem; font-weight:900; color:#E65100;" id="finalScorePost">0</div>
                <div id="scoreDescPost" style="color:#666;"></div>
            </div>
            <div class="diff-view" id="diffOutputPost"></div>
        </div>

        <div class="card-box" id="review-box" style="display:none; border:2px solid #FF9800;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">ğŸ–ï¸ ë²ˆë¬¸ ì •ë°€ ë¶„ì„ (í˜•ê´‘íœ ëª¨ë“œ)</h3>
                <div style="font-size:0.85rem; display:flex; gap:10px;">
                    <span class="hl-success">ì„±ê³µ(ìˆ˜ì •í•¨)</span>
                    <span class="hl-warning">ì˜¤ìˆ˜ì •(í‹€ë¦¼)</span>
                    <span class="hl-bad">ê°œì•…(ë§ì¹¨)</span>
                    <span class="hl-missed">ë¯¸ìˆ˜ì •</span>
                </div>
            </div>
            <div class="review-view" id="reviewContent"></div>
            <div style="margin-top:15px; background:#FFF3E0; padding:10px; border-radius:8px; font-size:0.9rem;">
                ğŸ’¡ <b>ë¶„ì„ ê°€ì´ë“œ:</b> ì›ë¬¸ê³¼ ë¹„êµí•˜ì—¬ 
                <span style="color:#00B894; font-weight:bold;">ì„±ê³µ</span>ì€ í‹€ë¦°ê±¸ ë§ê²Œ ê³ ì¹œ ê²ƒ, 
                <span style="color:#fbc02d; font-weight:bold;">ì˜¤ìˆ˜ì •</span>ì€ ê³ ì³¤ìœ¼ë‚˜ ì—¬ì „íˆ í‹€ë¦° ê²ƒ, 
                <span style="color:#ff5722; font-weight:bold;">ê°œì•…</span>ì€ ë§ì•˜ë˜ê±¸ í‹€ë¦¬ê²Œ ê³ ì¹œ ê²ƒì…ë‹ˆë‹¤.
            </div>
        </div>

    </div>

</main>

<script>
// ì‚¬ì´ë“œë°” í† ê¸€ ë° ê¸°ë³¸ ì„¤ì •
function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('active');
    document.querySelector('.sidebar-overlay').classList.toggle('active');
}

const GAS_URL = "https://script.google.com/macros/s/AKfycbyy-tcN11MycmXmaQjJ20KhLoOQzDqtr8b6YvwbLyF3OOVywlOzcm2EIkl_h4S9LoEFLQ/exec"; 
let currentUser = sessionStorage.getItem('shorthand_user');

function escapeHtml(str) {
    return String(str ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}
function toHtmlChar(ch) {
    if (ch === " ") return "&nbsp;";
    return escapeHtml(ch);
}

function initApp() {
    if (!currentUser) {
        alert("ë¡œê·¸ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”!");
        location.href = 'index.html'; 
        return;
    }
    document.getElementById('welcomeMsg').innerHTML = `ğŸ‘‹ <b>${escapeHtml(currentUser)}</b>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
    if(document.getElementById('sideUserName')) document.getElementById('sideUserName').innerText = currentUser;
    
    setupDragAndDrop('original');
    setupDragAndDrop('studentPre');
    setupDragAndDrop('studentPost');
    initAudioPlayer();
}

// ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ê´€ë ¨
const audio = document.getElementById('audioPlayer');
const playBtn = document.getElementById('playBtn');
const progressBar = document.getElementById('audioProgress');
const timeDisplay = document.getElementById('timeDisplay');

function initAudioPlayer() {
    audio.addEventListener('timeupdate', () => {
        if (!isNaN(audio.duration)) {
            progressBar.value = (audio.currentTime / audio.duration) * 100;
            updateTimeDisplay();
        }
    });
    audio.addEventListener('loadedmetadata', () => { updateTimeDisplay(); playBtn.disabled = false; });
    audio.addEventListener('ended', () => { playBtn.innerText = "â–¶"; progressBar.value = 0; });
}
function loadAudioFile(input) {
    const file = input.files[0];
    if (file) { audio.src = URL.createObjectURL(file); playBtn.innerText = "â–¶"; playBtn.disabled = false; }
}
function toggleAudio() {
    if (audio.paused) { audio.play(); playBtn.innerText = "â¸"; } 
    else { audio.pause(); playBtn.innerText = "â–¶"; }
}
function changeSpeed() { audio.playbackRate = parseFloat(document.getElementById('speedRate').value); }
function seekAudio() { audio.currentTime = (progressBar.value / 100) * audio.duration; }
function updateTimeDisplay() {
    const format = (t) => {
        const m = Math.floor(t / 60).toString().padStart(2, '0');
        const s = Math.floor(t % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    };
    timeDisplay.innerText = `${format(audio.currentTime)} / ${format(audio.duration || 0)}`;
}

function clearAllInputs() {
    if(confirm("ëª¨ë“  ë‚´ìš©ì„ ì§€ìš¸ê¹Œìš”?")) {
        document.getElementById('original').value = "";
        document.getElementById('studentPre').value = "";
        document.getElementById('studentPost').value = "";
        document.getElementById('result').style.display = 'none';
    }
}

// [í•µì‹¬] ì±„ì  ë° ë¶„ì„ ë¡œì§
function analyzeAndGrade() {
    const txtOriginal = document.getElementById('original').value;
    const txtPre = document.getElementById('studentPre').value;
    const txtPost = document.getElementById('studentPost').value;

    if(!txtOriginal.trim()) { alert("ì •ë‹µ(ì›ë³¸) í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    if(!txtPre.trim()) { alert("ë²ˆë¬¸ ì „(ì´ˆì•ˆ) í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    document.getElementById('result').style.display = 'block';

    // 1. ë²ˆë¬¸ ì „ ì±„ì  (í•„ìˆ˜)
    const resPre = getExactStats(txtOriginal, txtPre, true);
    document.getElementById('finalScorePre').innerText = resPre.score + "%";
    document.getElementById('scoreDescPre').innerText = `ì˜¤ì: ${resPre.w} / íƒˆì: ${resPre.mi} / ì²¨ì: ${resPre.ad}`;
    document.getElementById('diffOutputPre').innerHTML = resPre.html;

    // 2. ë²ˆë¬¸ í›„ ì±„ì  (ì„ íƒ)
    if (txtPost.trim()) {
        document.getElementById('result-post').style.display = 'block';
        document.getElementById('review-box').style.display = 'block';

        const resPost = getExactStats(txtOriginal, txtPost, true);
        document.getElementById('finalScorePost').innerText = resPost.score + "%";
        document.getElementById('scoreDescPost').innerText = `ì˜¤ì: ${resPost.w} / íƒˆì: ${resPost.mi} / ì²¨ì: ${resPost.ad}`;
        document.getElementById('diffOutputPost').innerHTML = resPost.html;

        // 3. í•˜ì´ë¼ì´íŠ¸ ë¶„ì„ ìƒì„±
        generateCorrectionHighlight(txtOriginal, txtPre, txtPost);
    } else {
        document.getElementById('result-post').style.display = 'none';
        document.getElementById('review-box').style.display = 'none';
    }
}

// ê¸°ë³¸ ì±„ì  í•¨ìˆ˜ (ì ìˆ˜ ê³„ì‚° ë° Diff HTML ìƒì„±)
function getExactStats(origin, student, generateHtml = false) {
    let rawO = origin.trim();
    let rawS = (student || "").trim();
    const isSpecial = (char) => /[^0-9a-zA-Z\uAC00-\uD7A3]/.test(char);
    let pureLength = rawO.replace(/[^0-9a-zA-Z\uAC00-\uD7A3]/g, '').length;
    let n = pureLength > 0 ? pureLength : 1;

    let oArr = rawO.split('');
    let sArr = rawS.split('');
    
    // LCS Logic
    let dp = Array.from(Array(oArr.length + 1), () => Array(sArr.length + 1).fill(0));
    for (let i = 1; i <= oArr.length; i++) {
        for (let j = 1; j <= sArr.length; j++) {
            if (oArr[i-1] === sArr[j-1]) dp[i][j] = dp[i-1][j-1] + 1;
            else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
        }
    }

    let i = oArr.length, j = sArr.length;
    let diffs = [];
    while (i > 0 || j > 0) {
        if (i > 0 && j > 0 && oArr[i-1] === sArr[j-1]) { 
            diffs.push({ t: 'same', c: oArr[i-1] }); i--; j--; 
        } else if (j > 0 && (i === 0 || dp[i][j-1] >= dp[i-1][j])) { 
            diffs.push({ t: 'added', c: sArr[j-1] }); j--; 
        } else { 
            diffs.push({ t: 'missing', c: oArr[i-1] }); i--;
        }
    }
    diffs.reverse();

    // Stats & HTML
    let w=0, mi=0, ad=0;
    let html = "";
    
    // Diff processing logic
    let mBuffer = [], aBuffer = [];
    
    const flushBuffer = () => {
        let mIdx = 0, aIdx = 0;
        while (mIdx < mBuffer.length || aIdx < aBuffer.length) {
            let mChar = mBuffer[mIdx];
            let aChar = aBuffer[aIdx];
            
            // íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬
            if (mIdx < mBuffer.length && isSpecial(mChar)) {
                if(generateHtml) html += `<span>${toHtmlChar(mChar)}</span>`;
                mIdx++; continue;
            }
            if (aIdx < aBuffer.length && isSpecial(aChar)) {
                if(generateHtml) html += `<span style="color:#ccc;">${toHtmlChar(aChar)}</span>`;
                aIdx++; continue;
            }
            // ì˜¤ì
            if (mIdx < mBuffer.length && aIdx < aBuffer.length) {
                if(generateHtml) html += `<span class="d-wrong">${toHtmlChar(aChar)}<span class="correction">${toHtmlChar(mChar)}</span></span>`;
                w++; mIdx++; aIdx++; continue;
            }
            // íƒˆì
            if (mIdx < mBuffer.length) {
                if(generateHtml) html += `<span class="d-missing">${toHtmlChar(mChar)}</span>`;
                mi++; mIdx++; continue;
            }
            // ì²¨ì
            if (aIdx < aBuffer.length) {
                if(generateHtml) html += `<span class="d-added">${toHtmlChar(aChar)}</span>`;
                ad++; aIdx++; continue;
            }
        }
        mBuffer = []; aBuffer = [];
    };

    for (let k = 0; k < diffs.length; k++) {
        let item = diffs[k];
        if (item.t === 'same') {
            flushBuffer();
            if(generateHtml) html += (item.c === '\n') ? '<br>' : `<span>${toHtmlChar(item.c)}</span>`;
        } else if (item.t === 'missing') {
            mBuffer.push(item.c);
        } else if (item.t === 'added') {
            aBuffer.push(item.c);
        }
    }
    flushBuffer();

    let adPenalty = Math.floor(ad / 3);
    let score = Math.max(0, 100 - ((w + mi + adPenalty) / n * 100)).toFixed(1);
    return { score, w, mi, ad, html };
}

// [ì‹ ê·œ ê¸°ëŠ¥] ë²ˆë¬¸ ìˆ˜ì • í•˜ì´ë¼ì´íŠ¸ ìƒì„±ê¸° (Highlighter Mode)
function generateCorrectionHighlight(txtOriginal, txtPre, txtPost) {
    // 1. Pre vs Post ë¹„êµ (ì–´ë””ê°€ ë°”ë€Œì—ˆë‚˜?)
    // 2. ë°”ë€ ë¶€ë¶„ì´ Originalê³¼ ì¼ì¹˜í•˜ëŠ”ê°€? (ì˜ ê³ ì³¤ë‚˜?)
    
    const cleanO = txtOriginal.replace(/\s+/g, ' ').trim(); // ê³µë°± ì •ê·œí™”
    const sPre = txtPre.trim().split('');
    const sPost = txtPost.trim().split('');
    
    // Pre vs Post LCS
    let dp = Array.from(Array(sPre.length + 1), () => Array(sPost.length + 1).fill(0));
    for (let i = 1; i <= sPre.length; i++) {
        for (let j = 1; j <= sPost.length; j++) {
            if (sPre[i-1] === sPost[j-1]) dp[i][j] = dp[i-1][j-1] + 1;
            else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
        }
    }

    let i = sPre.length, j = sPost.length;
    let changes = [];
    while (i > 0 || j > 0) {
        if (i > 0 && j > 0 && sPre[i-1] === sPost[j-1]) {
            changes.push({ t: 'same', c: sPre[i-1] }); i--; j--;
        } else if (j > 0 && (i === 0 || dp[i][j-1] >= dp[i-1][j])) {
            changes.push({ t: 'post_only', c: sPost[j-1] }); j--; // ìˆ˜ì • ì‹œ ì¶”ê°€/ë³€ê²½ë¨
        } else {
            changes.push({ t: 'pre_only', c: sPre[i-1] }); i--; // ìˆ˜ì • ì‹œ ì‚­ì œë¨
        }
    }
    changes.reverse();

    // HTML ìƒì„±
    let html = "";
    let bufferPost = ""; 
    let bufferPre = "";

    // ë©ì–´ë¦¬ ì²˜ë¦¬ í•¨ìˆ˜
    const processBuffer = () => {
        if (!bufferPost && !bufferPre) return;

        // 1. ë³€ê²½ ì—†ìŒ (Same)
        if (!bufferPre && bufferPost) { // ë‹¨ìˆœ í…ìŠ¤íŠ¸ (ìˆ˜ì • ì•ˆí•œ ë¶€ë¶„)
            // ì´ ë¶€ë¶„ì´ ì›ë¬¸ì—ë„ ìˆìœ¼ë©´ ì •ë‹µ, ì—†ìœ¼ë©´ ì˜¤ë‹µ(ë¯¸ìˆ˜ì •)
            // *ë‹¨ì–´ ë‹¨ìœ„ ì •ë°€ ë§¤ì¹­ì€ ë³µì¡í•˜ë¯€ë¡œ, ì—¬ê¸°ì„  ì‹œê°ì  í•˜ì´ë¼ì´íŠ¸ì— ì§‘ì¤‘*
            // ë³€ê²½ë˜ì§€ ì•Šì€ í…ìŠ¤íŠ¸ê°€ ì›ë¬¸ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ì•½ì‹)
            if (cleanO.includes(bufferPost.trim())) {
                html += `<span>${escapeHtml(bufferPost)}</span>`; // ì •ë‹µ ìœ ì§€
            } else if (bufferPost.trim().length > 1) { // 1ê¸€ì ì´ìƒ í‹€ë¦° ê²ƒ
                html += `<span class="hl-missed">${escapeHtml(bufferPost)}</span>`; // ë¯¸ìˆ˜ì •
            } else {
                html += `<span>${escapeHtml(bufferPost)}</span>`; // ì• ë§¤í•˜ë©´ ì¼ë°˜
            }
        }
        // 2. ìˆ˜ì • ë°œìƒ (Pre -> Post)
        else {
            let correctedText = bufferPost;
            let originalText = bufferPre;
            
            // ìˆ˜ì •í•œ ë‚´ìš©ì´ ì›ë¬¸ì— ìˆëŠ”ê°€?
            if (correctedText.trim().length > 0) {
                 if (cleanO.includes(correctedText.trim())) {
                     // ì„±ê³µ: ì›ë¬¸ì— ìˆìŒ
                     html += `<span class="hl-success">${escapeHtml(correctedText)}</span>`;
                 } else {
                     // ì‹¤íŒ¨: ê³ ì³¤ëŠ”ë° ì›ë¬¸ì— ì—†ìŒ
                     // ì›ë˜ ë§ì•˜ëŠ”ì§€ í™•ì¸? (ë³µì¡í•˜ë¯€ë¡œ ë‹¨ìˆœ ì˜¤ìˆ˜ì •/ê°œì•… êµ¬ë¶„)
                     if (cleanO.includes(originalText.trim()) && originalText.trim().length > 0) {
                         html += `<span class="hl-bad">${escapeHtml(correctedText)}</span>`; // ê°œì•… (ì›ë˜ ë§ì•˜ëŠ”ë°)
                     } else {
                         html += `<span class="hl-warning">${escapeHtml(correctedText)}</span>`; // ì˜¤ìˆ˜ì •
                     }
                 }
            }
        }
        bufferPost = ""; bufferPre = "";
    };

    for (let k = 0; k < changes.length; k++) {
        let ch = changes[k];
        if (ch.t === 'same') {
            // ë³€ê²½ ë¶€ë¶„ì´ ëë‚˜ë©´ ì´ì „ ë²„í¼ ì²˜ë¦¬
            if (bufferPre) processBuffer();
            bufferPost += ch.c; // sameë„ bufferPostì— ì¼ë‹¨ ë„£ê³ , ëŠê¸¸ ë•Œ ì²˜ë¦¬í•˜ê±°ë‚˜, ë°”ë¡œ ì²˜ë¦¬?
            // Sameì€ ì—°ì†ë˜ë¯€ë¡œ ë°”ë¡œ ì¶œë ¥í•˜ëŠ”ê²Œ ë‚˜ìŒ, í•˜ì§€ë§Œ "ë¯¸ìˆ˜ì •" ì²´í¬ë¥¼ ìœ„í•´ ë²„í¼ë§
            // ì—¬ê¸°ì„  ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ë°”ë¡œ ì¶œë ¥í•˜ë˜, ë¬¸ì¥ íë¦„ì„ ìœ„í•´...
            // ë¡œì§ ë‹¨ìˆœí™”: Sameì€ ê·¸ëƒ¥ ì¶œë ¥. ë³€ê²½ëœ ê²ƒë§Œ í•˜ì´ë¼ì´íŠ¸.
            
            // ë¯¸ìˆ˜ì • ì²´í¬ê°€ ë„ˆë¬´ ë¶‰ê²Œ ë‚˜ì˜¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë³€ê²½ëœ ê²ƒ ìœ„ì£¼ë¡œ í‘œì‹œ
            html += `<span>${toHtmlChar(ch.c)}</span>`;
        } else {
            // ë³€ê²½ ë°œìƒ
            if (ch.t === 'post_only') { // ì¶”ê°€ëœ ê¸€ì (ìˆ˜ì •ë³¸)
                // ë²„í¼ì— ìŒ“ì•„ì„œ ë‹¨ì–´ ë‹¨ìœ„ë¡œ ë¹„êµ
                // í¸ì˜ìƒ ë°”ë¡œ í•˜ì´ë¼ì´íŠ¸ ë¡œì§ ì ìš© (ë‹¨ì–´ ì¡°ê°ì¼ ìˆ˜ ìˆìŒ)
                // ê¸€ì ë‹¨ìœ„ë¡œ ì²´í¬í•˜ë©´ ì •í™•ë„ ë–¨ì–´ì§ -> "í•˜ì´ë¼ì´íŠ¸"ëŠ” ë©ì–´ë¦¬ê°€ ì¢‹ìŒ.
                // ì—¬ê¸°ì„  'ë‹¨ìˆœí™”'í•˜ì—¬ ê¸€ì ë‹¨ìœ„ ìŠ¤íƒ€ì¼ ì ìš©
                if (cleanO.includes(ch.c)) {
                    html += `<span class="hl-success">${toHtmlChar(ch.c)}</span>`;
                } else {
                    html += `<span class="hl-warning">${toHtmlChar(ch.c)}</span>`;
                }
            } 
            // pre_only (ì‚­ì œëœ ê¸€ì)ëŠ” í™”ë©´ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ (ë²ˆë¬¸ í›„ í…ìŠ¤íŠ¸ ê¸°ì¤€ì´ë¯€ë¡œ)
        }
    }
    
    // *ì •ë°€ í•˜ì´ë¼ì´íŠ¸ (ë‹¨ì–´ ë‹¨ìœ„)* êµ¬í˜„ì´ ë¸Œë¼ìš°ì €ì—ì„œ ë¬´ê±°ìš¸ ìˆ˜ ìˆì–´,
    // ìœ„ ì½”ë“œëŠ” ê¸€ì ë‹¨ìœ„ì…ë‹ˆë‹¤. ì„ ìƒë‹˜ ìš”ì²­ëŒ€ë¡œ "í˜•ê´‘íœ ëŠë‚Œ"ì„ ë‚´ê¸° ìœ„í•´
    // ì•½ê°„ì˜ ê¼¼ìˆ˜(ê¸€ì ë‹¨ìœ„ ìƒ‰ì¹ )ë¥¼ ì¼ìŠµë‹ˆë‹¤.
    // ë” ì •í™•í•œ "ë¬¸ë§¥" ë¹„êµëŠ” ì„œë²„ ì‚¬ì´ë“œë‚˜ ë¬´ê±°ìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
    document.getElementById('reviewContent').innerHTML = html;
}

// íŒŒì¼ ì½ê¸° ë° ë“œë˜ê·¸ì•¤ë“œë¡­ ìœ í‹¸
function loadFile(input, targetId) {
    const file = input.files[0];
    if (file) readFile(file, targetId);
}
function readFile(file, targetId) {
    const reader = new FileReader();
    reader.onload = function(e) { document.getElementById(targetId).value = e.target.result; };
    reader.readAsText(file, "UTF-8");
}
function setupDragAndDrop(areaId) {
    const area = document.getElementById(areaId);
    area.addEventListener("dragover", (e) => { e.preventDefault(); area.style.borderColor = "var(--primary)"; });
    area.addEventListener("dragleave", (e) => { e.preventDefault(); area.style.borderColor = "#E1E4E8"; });
    area.addEventListener("drop", (e) => { e.preventDefault(); area.style.borderColor = "#E1E4E8"; readFile(e.dataTransfer.files[0], areaId); });
}
function logout() { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { sessionStorage.clear(); location.href = 'index.html'; } }
function closeReport() { document.getElementById('overlay').style.display = 'none'; document.getElementById('report-modal').style.display = 'none'; }
</script>
</body>
</html>

