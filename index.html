<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DDOKSORI Season 2 | Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg-color: #f4f7f9; --card-bg: #ffffff; --text-color: #2c3e50; 
            --border-color: #e1e4e8; --main-blue: #3498db; --wrong-bg: #fff8f8;
        }
        body.dark-mode { 
            --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; 
            --border-color: #333; --wrong-bg: #2d1a1a;
        }

        body { font-family: 'Malgun Gothic', sans-serif; background-color: #2c3e50; margin: 0; padding: 0; transition: 0.3s; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; justify-content: center; align-items: center; z-index: 9999; padding: 20px; box-sizing: border-box; }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-box h2 { color: var(--main-blue); margin-bottom: 25px; font-size: 28px; }
        .login-box input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 18px; background: var(--main-blue); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 18px; margin-top: 20px; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        #app-content { display: none; background: var(--bg-color); min-height: 100vh; padding: 40px 20px; box-sizing: border-box; }
        .container { max-width: 1300px; margin: 0 auto; background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); color: var(--text-color); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid var(--main-blue); padding-bottom: 20px; }
        .header h2 { margin: 0; font-size: 28px; }

        .info-bar { display: grid; grid-template-columns: 1.5fr 1fr 0.8fr; gap: 20px; background: rgba(0,0,0,0.04); padding: 25px; border-radius: 12px; align-items: end; margin-bottom: 30px; }
        .info-bar div { display: flex; flex-direction: column; gap: 8px; }
        .info-bar input { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-color); font-size: 15px; }

        .input-section { display: flex; flex-direction: column; gap: 30px; margin-bottom: 40px; }
        textarea { width: 100%; height: 300px; padding: 20px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 18px; background: var(--card-bg); color: var(--text-color); line-height: 1.8; resize: none; box-sizing: border-box; }

        .btn-group { display: flex; gap: 15px; margin-bottom: 40px; }
        .main-btn { flex: 2; padding: 20px; background: var(--main-blue); color: white; font-size: 20px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .save-btn { flex: 1; padding: 20px; background: #27ae60; color: white; font-size: 18px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }

        /* ê²°ê³¼ ì˜ì—­ */
        .score-num { font-size: 70px; font-weight: 900; color: var(--main-blue); text-align: center; margin-bottom: 10px; }
        .diff-view { background: var(--card-bg); padding: 35px; border: 1px solid var(--border-color); border-radius: 15px; font-size: 21px; line-height: 2.8; white-space: pre-wrap; word-break: break-all; margin-top: 20px; }
        
        .wrong-note { background: var(--wrong-bg); padding: 25px; border-radius: 15px; border-left: 8px solid #e74c3c; margin-bottom: 30px; }
        .wrong-tag { display: inline-block; background: #e74c3c; color: white; padding: 6px 14px; border-radius: 6px; margin: 4px; font-size: 15px; font-weight: bold; }

        /* ê°•ì¡° ìƒ‰ìƒ */
        .d-missing { color: #e74c3c; font-weight: bold; background: rgba(231, 76, 60, 0.1); padding: 0 4px; }
        .d-added { color: #27ae60; font-weight: bold; background: rgba(39, 174, 96, 0.1); text-decoration: underline; padding: 0 4px; }
        .d-wrong { color: #2980b9; font-weight: bold; background: rgba(41, 128, 185, 0.1); padding: 0 4px; }
        .correction { font-size: 0.65em; vertical-align: super; color: #3498db; margin-left: 2px; border: 1px solid #3498db; padding: 1px 3px; border-radius: 3px; background: #fff; font-weight: normal; }

        .bottom-section { display: grid; grid-template-columns: 1fr; gap: 40px; margin-top: 50px; }
        .chart-container { height: 400px; background: white; padding: 20px; border-radius: 15px; border: 1px solid var(--border-color); }
        @media (min-width: 768px) { .input-section { flex-direction: row; } .bottom-section { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body class="">

<div id="login-overlay">
    <div class="login-box">
        <h2>âŒ¨ï¸ DDOKSORI <span style="font-weight: 300;">S2</span></h2>
        <input type="text" id="loginName" placeholder="ì„±í•¨">
        <input type="password" id="loginPw" placeholder="ì—°ë½ì²˜">
        <button onclick="checkAuth()">ì‹œìŠ¤í…œ ì ‘ì†</button>
        <p id="loginMsg" style="color:red; font-size:13px; margin-top:10px;"></p>
    </div>
</div>

<div id="app-content">
    <div class="container">
        <div class="header">
            <h2>âŒ¨ï¸ SHORTHAND MASTER <span style="font-weight: 300; font-size: 18px; color: #7f8c8d; margin-left: 10px;">| ì „ë¬¸ ë¶„ì„ ë²„ì „</span></h2>
            <div>
                <button onclick="document.body.classList.toggle('dark-mode')" style="padding:8px 15px; border-radius:20px; border:1px solid #ccc; cursor:pointer;">ğŸŒ“ í…Œë§ˆ</button>
                <button onclick="logout()" style="padding:8px 15px; border-radius:20px; border:1px solid #ccc; cursor:pointer; margin-left:5px;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        
        <div class="info-bar">
            <div><strong>ğŸ“Œ ì—°ìŠµ ì§€ë¬¸</strong><input type="text" id="docTitle" placeholder="ì§€ë¬¸ ì œëª© ì…ë ¥"></div>
            <div><strong>ğŸ‘¤ í•™ìƒ ì •ë³´</strong><input type="text" id="studentDisplay" readonly style="font-weight:bold; color:#3498db; background:#fff;"></div>
            <div><strong>ğŸ¯ í•©ê²© ëª©í‘œ</strong><div style="display:flex; align-items:center; gap:5px;"><input type="number" id="targetScore" value="95" style="width:70px;"> %</div></div>
            <input type="hidden" id="studentPhone">
        </div>

        <div class="input-section">
            <div style="flex:1;"><label style="font-weight:bold; display:block; margin-bottom:10px;">ğŸ“„ ì •ë‹µ ì›ë¬¸</label><textarea id="original"></textarea></div>
            <div style="flex:1;"><label style="font-weight:bold; display:block; margin-bottom:10px;">âœï¸ í•™ìƒ ì…ë ¥</label><textarea id="student"></textarea></div>
        </div>

        <div class="btn-group">
            <button class="main-btn" onclick="analyzeAndGrade()">ğŸ’¯ ì‹¤ì‹œê°„ ì •ë°€ ë¶„ì„ ì‹¤í–‰</button>
            <button id="saveBtn" class="save-btn" onclick="saveToCloud()" style="display:none;">ğŸ“¥ ì„œë²„ì— ê¸°ë¡ ì €ì¥</button>
        </div>

        <div id="resultArea" style="display:none;">
            <div class="score-num" id="finalScoreDisplay">0%</div>
            <div id="scoreDesc" style="text-align:center; font-size: 18px; color: #7f8c8d; margin-bottom:30px;"></div>

            <div id="wrongWordsNote" class="wrong-note" style="display:none;">
                <strong>ğŸ“‹ ì§‘ì¤‘ ë³´ì¶© í•™ìŠµ (ì˜¤ì ë¦¬ìŠ¤íŠ¸)</strong>
                <div id="wrongWordsList" style="margin-top:15px;"></div>
            </div>

            <label style="font-weight:bold; font-size:18px;">ğŸ§ ìƒì„¸ ë¶„ì„ ê²°ê³¼ (ê¸°í˜¸ ë³´ì¡´)</label>
            <div class="diff-view" id="diffOutput"></div>
        </div>

        <div class="bottom-section">
            <div class="chart-box">
                <label style="font-weight:bold; display:block; margin-bottom:15px;">ğŸ“ˆ ì„±ì  ì¶”ì´</label>
                <div class="chart-container"><canvas id="scoreChart"></canvas></div>
            </div>
            <div class="history-box">
                <label style="font-weight:bold; display:block; margin-bottom:15px;">ğŸ“‹ ì—°ìŠµ ê¸°ë¡ íˆìŠ¤í† ë¦¬</label>
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; text-align:center; font-size:14px;">
                        <thead style="background:#f8f9fa;"><tr><th style="padding:10px;">ë‚ ì§œ</th><th>ì§€ë¬¸</th><th>ì˜¤/íƒˆ/ì²¨</th><th>ì ìˆ˜</th></tr></thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const SHEET_ID = '17SFATNdgT0YFk9o3WzjEmKtk_BjrNPZfwBmJuaeB3s4'; 
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxs0JKdgmCaRpLQqcTycQ-vnmei-VMqIGu9pIT-oKjSWoXH2T4M55jYtQKz4K4ob1s/exec';
let currentResult = null; let scoreChart = null;

window.onload = function() {
    const savedName = sessionStorage.getItem('sh_name');
    const savedPhone = sessionStorage.getItem('sh_phone');
    if(savedName && savedPhone) enterApp(savedName, savedPhone);
};

async function checkAuth() {
    const name = document.getElementById('loginName').value.trim();
    const pw = document.getElementById('loginPw').value.trim();
    if(!name || !pw) return;
    document.getElementById('loginMsg').innerText = "ì¸ì¦ ì¤‘...";
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=ì‹œíŠ¸1`;
        const response = await fetch(url);
        const data = await response.text();
        const rows = data.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '').trim()));
        let user = rows.find(r => r[0] === name && r[2] === pw);
        if(user && user[3] === 'í—ˆìš©') {
            sessionStorage.setItem('sh_name', name);
            sessionStorage.setItem('sh_phone', pw);
            enterApp(name, pw);
        } else { document.getElementById('loginMsg').innerText = "ì •ë³´ ë¶ˆì¼ì¹˜"; }
    } catch (e) { document.getElementById('loginMsg').innerText = "ì—°ê²° ì˜¤ë¥˜"; }
}

function enterApp(name, phone) {
    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('app-content').style.display = 'block';
    document.getElementById('studentDisplay').value = name;
    document.getElementById('studentPhone').value = phone;
    initChart(); loadCloudData(phone);
}

function logout() { sessionStorage.clear(); location.reload(); }

async function loadCloudData(phone) {
    try {
        const response = await fetch(`${WEB_APP_URL}?name=${encodeURIComponent(phone)}`);
        const data = await response.json(); renderHistory(data);
    } catch (e) { console.error(e); }
}

async function saveToCloud() {
    if(!currentResult) return;
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.innerText = "ì €ì¥ ì¤‘..."; saveBtn.disabled = true;
    const payload = {
        name: document.getElementById('studentPhone').value,
        displayName: document.getElementById('studentDisplay').value,
        title: document.getElementById('docTitle').value || "ë¯¸ì§€ì •",
        score: currentResult.score, wrong: currentResult.wrong, missing: currentResult.missing, added: currentResult.added
    };
    try {
        await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
        alert("ì €ì¥ ì„±ê³µ!"); saveBtn.innerText = "ì €ì¥ ì™„ë£Œ"; loadCloudData(payload.name); 
    } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨"); saveBtn.disabled = false; saveBtn.innerText = "ì¬ì‹œë„"; }
}

function analyzeAndGrade() {
    let rawO = document.getElementById('original').value;
    let rawS = document.getElementById('student').value;
    if(!rawO.trim() || !rawS.trim()) return;

    let cleanO = rawO.replace(/[^a-z0-9ê°€-í£]/gi, '').split('');
    let cleanS = rawS.replace(/[^a-z0-9ê°€-í£]/gi, '').split('');

    let n = cleanO.length, m = cleanS.length;
    let dp = Array.from(Array(n + 1), () => Array(m + 1).fill(0));
    for(let i=1; i<=n; i++) {
        for(let j=1; j<=m; j++) {
            dp[i][j] = (cleanO[i-1] === cleanS[j-1]) ? dp[i-1][j-1]+1 : Math.max(dp[i-1][j], dp[i][j-1]);
        }
    }

    let i=n, j=m, diffs = [];
    while(i>0 || j>0) {
        if(i>0 && j>0 && cleanO[i-1] === cleanS[j-1]) { diffs.push({t:'s', c:cleanO[i-1]}); i--; j--; }
        else if(i>0 && j>0) { diffs.push({t:'w', c:cleanS[j-1], o:cleanO[i-1]}); i--; j--; }
        else if(j>0) { diffs.push({t:'a', c:cleanS[j-1]}); j--; }
        else { diffs.push({t:'m', c:cleanO[i-1]}); i--; }
    }
    diffs.reverse();

    let finalHtml = ""; let currentPos = 0; let wrong=0, missing=0, added=0; let wList = [];
    let fullOriginal = rawO.split('');

    fullOriginal.forEach(char => {
        if (/[^a-z0-9ê°€-í£]/i.test(char)) { finalHtml += char; }
        else {
            let res = diffs[currentPos];
            if (res) {
                if (res.t === 's') finalHtml += `<span>${res.c}</span>`;
                else if (res.t === 'w') {
                    finalHtml += `<span class="d-wrong">${res.c}<span class="correction">${res.o}</span></span>`;
                    wrong++; wList.push(`${res.o}â†’${res.c}`);
                } else if (res.t === 'm') {
                    finalHtml += `<span class="d-missing">${res.c}</span>`;
                    missing++;
                }
                let next = diffs[currentPos + 1];
                while(next && next.t === 'a') {
                    finalHtml += `<span class="d-added">${next.c}</span>`;
                    added++; currentPos++; next = diffs[currentPos + 1];
                }
                currentPos++;
            }
        }
    });

    let score = n > 0 ? Math.max(0, 100 - ((wrong + missing + added) / n * 100)).toFixed(1) : 0;
    currentResult = { score, wrong, missing, added };
    document.getElementById('finalScoreDisplay').innerText = score + "%";
    document.getElementById('scoreDesc').innerText = `ë¶„ì„ ê²°ê³¼: ì˜¤ì ${wrong} / íƒˆì ${missing} / ì²¨ì ${added}`;
    document.getElementById('diffOutput').innerHTML = finalHtml;
    
    if(wList.length > 0) {
        document.getElementById('wrongWordsNote').style.display = 'block';
        document.getElementById('wrongWordsList').innerHTML = [...new Set(wList)].map(w => `<span class="wrong-tag">${w}</span>`).join('');
    } else { document.getElementById('wrongWordsNote').style.display = 'none'; }
    
    document.getElementById('resultArea').style.display = 'block';
    document.getElementById('saveBtn').style.display = 'block';
    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
}

function initChart() {
    const ctx = document.getElementById('scoreChart').getContext('2d');
    if(scoreChart) scoreChart.destroy();
    scoreChart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label: 'ì •í™•ë„(%)', data: [], borderColor: '#3498db', tension: 0.3, fill: true, backgroundColor: 'rgba(52, 152, 219, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false } });
}

function renderHistory(data) {
    let tbody = document.getElementById("historyTableBody"); tbody.innerHTML = "";
    scoreChart.data.labels = []; scoreChart.data.datasets[0].data = [];
    data.slice(1).forEach((row, idx) => {
        const dateStr = row[0].split(' ')[0];
        let numScore = parseFloat(row[6]); if (numScore <= 1) numScore *= 100;
        let newRow = `<tr><td style="padding:10px;">${dateStr}</td><td>${row[2]}</td><td>${row[3]}/${row[4]}/${row[5]}</td><td><b>${numScore.toFixed(1)}%</b></td></tr>`;
        tbody.innerHTML = newRow + tbody.innerHTML;
        scoreChart.data.labels.push(idx + 1 + "íšŒ"); scoreChart.data.datasets[0].data.push(numScore);
    });
    scoreChart.update();
}
</script>
</body>
</html>
